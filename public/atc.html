<!doctype html>
<html lang="zh-Hant">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
</script>
  <meta charset="utf-8" />
  <title>GeoFS ATC Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Photo Map Markers */
.plane-marker {
  font-size: 24px;
  cursor: pointer;
}

.photo-popup {
  max-width: 300px;
}

.photo-popup img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  cursor: pointer;
}

.photo-popup h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
  color: #333;
}

.photo-popup .info {
  font-size: 0.85rem;
  color: #666;
  margin: 0.3rem 0;
}

.photo-popup .tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  margin-top: 0.5rem;
}

.photo-popup .tag {
  background: #667eea;
  color: white;
  padding: 0.2rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
}
/* Aircraft Label Hover Effect */
.leaflet-aircraft-icon .aircraft-tag {
  transition: background-color 0.2s ease, opacity 0.2s ease;
}

.leaflet-aircraft-icon:hover .aircraft-tag {
  background-color: rgba(0, 0, 0, 0.8) !important;
}

/* Aircraft Panel Modern Styling */
#aircraftPanel {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

#aircraftPanel button {
  transition: all 0.2s ease;
}
/* Photo Map Toggle */
#photoMapToggle {
  position: fixed;
  left: 10px;
  top: 100px;
  background: rgba(102, 126, 234, 0.95);
  color: #fff;
  border: none;
  padding: 10px 15px;
  cursor: pointer;
  z-index: 99996;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

#photoMapToggle:hover {
  background: rgba(118, 75, 162, 0.95);
}

#photoMapToggle.active {
  background: rgba(118, 75, 162, 0.95);
}
    /* å´é‚Šç…§ç‰‡é¢æ¿ */
#photoSidebar {
  position: fixed;
  right: -320px;
  top: 0;
  width: 300px;
  height: 100%;
  background: rgba(22, 27, 34, 0.95);
  box-shadow: -2px 0 10px rgba(0,0,0,0.5);
  transition: right 0.3s ease;
  z-index: 99997;
  overflow-y: auto;
  padding: 10px;
}

#photoSidebar.open {
  right: 0;
}

#photoToggle {
  position: fixed;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(22, 27, 34, 0.95);
  color: #fff;
  border: none;
  padding: 20px 10px;
  cursor: pointer;
  z-index: 99998;
  border-radius: 6px 0 0 6px;
  font-size: 18px;
  box-shadow: -2px 0 8px rgba(0,0,0,0.4);
}

#photoToggle:hover {
  background: rgba(35, 134, 54, 0.95);
}

.photo-item {
  margin-bottom: 15px;
  background: #0d1117;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.photo-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}

.photo-item img:hover {
  transform: scale(1.05);
}

.photo-item .caption {
  padding: 8px;
  font-size: 12px;
  color: #e6edf3;
}
/* æ–°çš„ Discord æŒ‰éˆ•å®¹å™¨ */
.social-buttons {
  position: fixed;
  bottom: 10px;
  left: 10px;
  display: flex;
  gap: 10px;
  z-index: 99997; /* z-index ä¿æŒä¸è®Š */
}

/* æŒ‰éˆ•çš„é€šç”¨æ¨£å¼ (æœªä¾†å¯æ“´å……) */
.social-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}

/* Discord æŒ‰éˆ•çš„å°ˆå±¬é¡è‰² */
.discord-btn {
  background: #5865F2;
  color: white;
}
    .github-ribbon {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 150px;
  height: 150px;
  overflow: hidden;
  z-index: 99998;
  pointer-events: none;
}
.github-ribbon a {
  position: absolute;
  bottom: 35px;
  left: -40px;
  transform: rotate(45deg);
  width: 200px;
  background: #c0392b;
  color: white;
  text-align: center;
  padding: 8px 0;
  font-family: Arial, sans-serif;
  font-size: 13px;
  font-weight: bold;
  text-decoration: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  pointer-events: auto;
  transition: background 0.3s ease;
}
.github-ribbon a:hover {
  background: #a93226;
}
    html,body,#map { height:100%; margin:0; padding:0; }
    .label {
      font-family: Inter, "Noto Sans TC", Arial, sans-serif;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5);
      white-space: nowrap;
      margin-left: 6px;
    }
    .label.emergency {
      background: rgba(139, 0, 0, 0.95);
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
      50% { box-shadow: 0 0 15px rgba(255,0,0,0.8); }
    }
    .legend {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(146, 146, 146, 0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .altitude-legend {
      position: absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(146, 146, 146, 0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:11px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      min-width: 140px;
    }
    .altitude-legend-item {
      display: flex;
      align-items: center;
      margin: 2px 0;
    }
    .altitude-color-box {
      width: 12px;
      height: 12px;
      margin-right: 6px;
      border-radius: 2px;
    }
    .waypoint-tooltip {
      font-size: 11px !important;
      padding: 3px 6px !important;
      background: rgba(0, 0, 0, 0.85) !important;
      border: 1px solid #ff6600 !important;
      border-radius: 4px !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
      font-weight: bold;
      color: #fff !important;
    }
    .waypoint-tooltip::before {
      border-top-color: rgba(0, 0, 0, 0.85) !important;
    }
    .waypoint-marker {
      background: rgba(255, 102, 0, 0.9);
      border: 3px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      font-size: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .waypoint-passed {
      background: rgba(100, 100, 100, 0.7) !important;
      border-color: #666 !important;
    }
    .waypoint-active {
      background: rgba(0, 255, 0, 0.9) !important;
      border-color: #0f0 !important;
      animation: pulse-active 1.5s ease-in-out infinite;
    }
    @keyframes pulse-active {
      0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,255,0,0.4); }
      50% { transform: scale(1.2); box-shadow: 0 2px 15px rgba(0,255,0,0.8); }
    }
    .route-arrow {
      font-size: 16px;
      color: #ff6600;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <!-- Photo Map Toggle Button -->
<button id="photoMapToggle" onclick="togglePhotoMap()">ğŸ“ Photo Map</button>
  <!-- å´é‚Šç…§ç‰‡é¢æ¿ -->
<button id="photoToggle" onclick="togglePhotoSidebar()">ğŸ“·</button>
<div id="photoSidebar">
  <h3 style="color:#58a6ff;margin-top:0;">JetPhotos Gallery</h3>
  <div id="photoPanel"></div>
</div>
<div class="github-ribbon">
  <a href="https://github.com/seabus0316/GeoFS-flightradar/tree/main" target="_blank">
    Visit GitHub Page
  </a>
</div>
<div class="social-buttons">
  <a href="https://discord.gg/YKfdMHPC2Y" class="social-btn discord-btn" target="_blank">
    <img src="https://cdn.prod.website-files.com/6257adef93867e50d84d30e2/66e3d7f4ef6498ac018f2c55_Symbol.svg" alt="Discord" style="width: 30px; height: 30px;">
  </a>
</div>
<div id="map"></div>
<div class="legend">GeoFS ATC â€” connected: <span id="connCount">0</span></div>
<div class="altitude-legend">
  <div style="font-weight:bold;margin-bottom:4px;">é«˜åº¦åœ–ä¾‹</div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffffff;"></div><span>&lt;100m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffff00;"></div><span>100m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00ff00;"></div><span>~1000m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00bfff;"></div><span>2500m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#0000ff;"></div><span>é«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#800080;"></div><span>æ¥µé«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ff0000;"></div><span>æœ€é«˜ç©º</span></div>
</div>

<!-- UTC Time Box with Clocks -->
<div id="utcTime" style="position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.85); color: white; padding: 12px; border-radius: 8px; font-size: 14px; font-family: Arial, sans-serif; z-index: 99995; box-shadow: 0 2px 8px rgba(0,0,0,0.5);">
  <div style="margin-bottom: 8px; font-weight: bold;">UTC Time: <span id="utcTimeText">--</span></div>
  <div id="clockContainer" style="display: flex; gap: 15px; justify-content: center;">
    <!-- Clocks will be inserted here -->
  </div>
</div>
<!-- ä»¿ Flightradar24 åº•éƒ¨åœ–è¡¨å®¹å™¨ -->
<div id="flightChartContainer"
  style="position:fixed;left:0;right:0;bottom:0;height:180px;background:#222;z-index:99999;
    padding:12px 10px 0 10px;display:none;box-shadow:0 -2px 12px #000;">
  <div style="font-family:'Inter','Noto Sans TC',Arial,sans-serif;font-size:14px;color:#fff;font-weight:bold;margin-bottom:3px;">
    SPEED & ALTITUDE GRAPH
  </div>
  <div style="height:155px;padding-bottom:10px;">
    <canvas id="flightChart"></canvas>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>
<script>
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
// Chart.js ä»¿ Flightradar24 é¢¨æ ¼

let flightChartObj;

// è³‡æ–™æŠ½ç¨€å‡½æ•¸ - ä½¿ç”¨ Douglas-Peucker ç°¡åŒ–ç®—æ³•
// ğŸ”§ æ”¹é€²çš„è³‡æ–™æŠ½ç¨€å‡½æ•¸ - ä¿è­‰æ™‚é–“å‡å‹»åˆ†ä½ˆ
function simplifyTrackData(track, maxPoints = 200) {
  if (track.length <= maxPoints) return track;
  
  // ç­–ç•¥:çµåˆæ™‚é–“å‡å‹»æ¡æ¨£ + é‡è¦é»ä¿ç•™
  const result = [];
  
  // 1. ä¸€å®šä¿ç•™é¦–å°¾
  result.push(track[0]);
  
  // 2. è¨ˆç®—æ™‚é–“è·¨åº¦
  const firstTs = track[0].ts || 0;
  const lastTs = track[track.length - 1].ts || 0;
  const totalDuration = lastTs - firstTs;
  
  if (totalDuration === 0) {
    // æ²’æœ‰æ™‚é–“æˆ³,æŒ‰ç´¢å¼•å‡å‹»æ¡æ¨£
    const step = Math.ceil(track.length / maxPoints);
    for (let i = step; i < track.length - 1; i += step) {
      result.push(track[i]);
    }
  } else {
    // æœ‰æ™‚é–“æˆ³,æŒ‰æ™‚é–“å‡å‹»æ¡æ¨£
    const targetInterval = totalDuration / (maxPoints - 2); // æ¸›å»é¦–å°¾
    let lastAddedTs = firstTs;
    
    for (let i = 1; i < track.length - 1; i++) {
      const point = track[i];
      const currentTs = point.ts || 0;
      
      // è¨ˆç®—é‡è¦æ€§åˆ†æ•¸
      const prev = track[i - 1];
      const next = track[i + 1];
      const altChange = Math.abs(point.alt - prev.alt) + Math.abs((next.alt || 0) - point.alt);
      const speedChange = Math.abs(point.speed - prev.speed) + Math.abs((next.speed || 0) - point.speed);
      const importance = altChange + speedChange * 0.1;
      
      // æ™‚é–“åˆ°äº†æˆ–é‡è¦æ€§å¾ˆé«˜å°±ä¿ç•™
      const timeSinceLastAdded = currentTs - lastAddedTs;
      if (timeSinceLastAdded >= targetInterval || importance > 500) {
        result.push(point);
        lastAddedTs = currentTs;
      }
    }
  }
  
  // 3. ä¿ç•™æœ€å¾Œä¸€å€‹é»
  result.push(track[track.length - 1]);
  
  console.log(`ğŸ“‰ Simplified ${track.length} â†’ ${result.length} points`);
  return result;
}

function showFlightChart(track) {
  const container = document.getElementById('flightChartContainer');
  container.style.display = 'block';
  const ctx = document.getElementById('flightChart').getContext('2d');

  // ğŸ”§ å¢åŠ æŠ½ç¨€é»æ•¸ä¸Šé™è‡³ 500
  const simplifiedTrack = simplifyTrackData(track, 500);
  
  // è¨ˆç®—æ™‚é–“è·¨åº¦,å‹•æ…‹èª¿æ•´æ¨™ç±¤æ ¼å¼
  const firstTs = simplifiedTrack[0]?.ts;
  const lastTs = simplifiedTrack[simplifiedTrack.length - 1]?.ts;
  const timeSpanHours = firstTs && lastTs ? (lastTs - firstTs) / (1000 * 60 * 60) : 0;
  
  console.log(`ğŸ“Š Chart: ${simplifiedTrack.length} points, ${timeSpanHours.toFixed(1)}h span`);
  
  // æ ¹æ“šæ™‚é–“è·¨åº¦é¸æ“‡æ ¼å¼
  let timeFormat;
  let maxTicks;
  if (timeSpanHours > 6) {
    // è¶…é 6 å°æ™‚ï¼šåªé¡¯ç¤ºå°æ™‚
    timeFormat = { hour: '2-digit', hour12: false };
    maxTicks = 12;
  } else if (timeSpanHours > 2) {
    // 2-6 å°æ™‚ï¼šé¡¯ç¤ºå°æ™‚:åˆ†é˜ï¼ˆæ¯ 30 åˆ†é˜ï¼‰
    timeFormat = { hour: '2-digit', minute: '2-digit', hour12: false };
    maxTicks = 15;
  } else {
    // å°‘æ–¼ 2 å°æ™‚ï¼šé¡¯ç¤ºè©³ç´°æ™‚é–“
    timeFormat = { hour: '2-digit', minute: '2-digit', hour12: false };
    maxTicks = 12;
  }

  // X è»¸æ¨™ç±¤ - ä½¿ç”¨æŠ½ç¨€å¾Œçš„è³‡æ–™
  const labels = simplifiedTrack.map((p, i) => {
    if (p.ts) {
      const dt = new Date(p.ts);
      return dt.toLocaleTimeString('en-GB', timeFormat);
    }
    return i + 1;
  });
  
  const altitudes = simplifiedTrack.map(p => Math.round(p.alt));
  const speeds = simplifiedTrack.map(p => Math.round(formatSpeed(p.speed)));

  if (!flightChartObj) {
    flightChartObj = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Ground Speed',
            data: speeds,
            borderColor: '#ffd300',
            backgroundColor: 'rgba(255,211,0,0.07)',
            pointRadius: 0, // é—œé–‰é»ï¼Œè®“ç·šæ›´æ¸…æ™°
            yAxisID: 'y-speed',
            tension: 0.25
          },
          {
            label: 'Altitude',
            data: altitudes,
            borderColor: '#00b4ff',
            backgroundColor: 'rgba(0,180,255,0.07)',
            pointRadius: 0, // é—œé–‰é»
            yAxisID: 'y-alt',
            tension: 0.25
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
       plugins: {
          legend: {
            display: true,
            labels: {
              color: "#fff",
              font: { family: 'Inter', size: 14, weight: 'bold' }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: "#222",
            borderColor: "#ffd300",
            borderWidth: 2,
            callbacks: {
              title: (items) => {
                const idx = items[0].dataIndex;
                const p = simplifiedTrack[idx];
                if (p.ts)
                  return new Date(p.ts).toLocaleString('en-GB', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                  });
                return `Point ${idx+1}`;
              },
              label: (item) => {
                if (item.dataset.label === "Ground Speed")
                  return `Ground Speed: ${item.formattedValue} kt`;
                else
                  return `Altitude: ${item.formattedValue} ft`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: false },
            ticks: {
              color: "#fff",
              font: { size: 11 },
              maxRotation: 45,
              minRotation: 0,
              autoSkip: true,
              maxTicksLimit: maxTicks, // å‹•æ…‹èª¿æ•´
              display: true
            },
            grid: { color: "#444" },
            display: true
          },
          'y-alt': {
            type: 'linear',
            position: 'left',
            title: {
              display: true,
              text: 'Altitude (ft)',
              color: "#00b4ff",
              font: { size: 13, weight:'bold' }
            },
            grid: { color: "#444" },
            ticks: { color: "#00b4ff", font: { size: 13 } }
          },
          'y-speed': {
            type: 'linear',
            position: 'right',
            title: {
              display: true,
              text: 'Speed (kt)',
              color: "#ffd300",
              font: { size: 13, weight:'bold' }
            },
            grid: { drawOnChartArea: false },
            ticks: { color: "#ffd300", font: { size: 13 } }
          }
        }
      }
    });
  } else {
    // å¹³æ»‘æ›´æ–°è³‡æ–™
    const simplifiedTrack = simplifyTrackData(track, 200);
    const labels = simplifiedTrack.map((p, i) => {
      if (p.ts) {
        const dt = new Date(p.ts);
        return dt.toLocaleTimeString('en-GB', timeFormat);
      }
      return i + 1;
    });
    const speeds = simplifiedTrack.map(p => Math.round(formatSpeed(p.speed)));
    const altitudes = simplifiedTrack.map(p => Math.round(p.alt));
    
    flightChartObj.data.labels = labels;
    flightChartObj.data.datasets[0].data = speeds;
    flightChartObj.data.datasets[1].data = altitudes;
    flightChartObj.options.scales.x.ticks.maxTicksLimit = maxTicks; // æ›´æ–° maxTicks
    flightChartObj.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼åŠ å¿«æ›´æ–°é€Ÿåº¦
  }
}
function hideFlightChart() {
  document.getElementById('flightChartContainer').style.display = 'none';
  if (flightChartObj) {
    flightChartObj.destroy();
    flightChartObj = null;
  }
}
// å·¥å…·å‡½å¼
function getAltitudeColor(altFt) {
  const alt = altFt || 0;
  if (alt < 330) return "#ffffff";
  if (alt < 3300) return "#ffff00";
  if (alt < 8200) return "#00ff00";
  if (alt < 20000) return "#00bfff";
  if (alt < 30000) return "#0000ff";
  if (alt < 40000) return "#800080";
  return "#ff0000";
}
function formatSpeed(speedRaw) {
  if (typeof speedRaw !== 'number') return '---';
  let speed = speedRaw;
  if (speedRaw < 50) speed = speedRaw * 1.94384;
  return Math.round(speed);
}
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, function(c) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[c];
  });
}
// ç…§ç‰‡å´é‚Šæ¬„åˆ‡æ›
function togglePhotoSidebar() {
  const sidebar = document.getElementById('photoSidebar');
  sidebar.classList.toggle('open');
}

// è¼‰å…¥ç…§ç‰‡ï¼ˆä¿®æ”¹åŸæœ‰çš„ fetch éƒ¨åˆ†ï¼‰
fetch('/api/photos')
  .then(r => r.json())
  .then(list => {
    const panel = document.getElementById('photoPanel');
    panel.innerHTML = '';
    list.forEach(p => {
      const item = document.createElement('div');
      item.className = 'photo-item';
      item.innerHTML = `
        <img src="${p.thumb}" alt="${p.caption || ''}" onclick="window.open('${p.thumb}', '_blank')">
        <div class="caption">
          <strong>${p.caption || 'Untitled'}</strong><br>
          <small>ğŸ“¸ ${p.photographer || 'Anonymous'}</small>
        </div>
      `;
      panel.appendChild(item);
    });
  })
  .catch(err => console.error('è¼‰å…¥ç…§ç‰‡å¤±æ•—:', err));
// åœ°åœ–è¨­å®š
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
});
const Thunderforest_Transport = L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}{r}.png?apikey=7e63f2f7d95e4361ae0c15d5ab9b7f99', {
  attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
});
const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleHybrid = L.tileLayer('https://mt0.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleTer = L.tileLayer('http://mt0.google.com/vt/lyrs=p&hl=en&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});

// é«˜å¾·åœ°å›¾ (Amap)
const amapStreets = L.tileLayer(
  'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',
  {
    subdomains: "1234",
    attribution: '&copy; <a href="https://www.amap.com/">é«˜å¾·åœ°å›¾</a>'
  }
);

const amapSatellite = L.tileLayer(
  'https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
  {
    subdomains: "1234",
    attribution: '&copy; <a href="https://www.amap.com/">é«˜å¾·åœ°å›¾å«æ˜Ÿ</a>'
  }
);

const openAIP = L.tileLayer(
  'https://api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=409a25682b90c26541b6c25493950e17',
  {
    attribution: '&copy; <a href="https://www.openaip.net/">OpenAIP</a>',
    maxZoom: 18,
    maxNativeZoom: 14,
    transparent: true,
    opacity: 0.8
  }
);

const map = L.map('map', {
  worldCopyJump: false,
  maxZoom: 18,
  minZoom: 2,
  maxBounds: [[-85, -360], [85, 360]],
  layers: [googleSat,openAIP]
}).setView([20,0],2);

// æ–°å¢ waypointPane (z-index æ¯” tilePaneé«˜,æ¯”overlayPaneä½)
map.createPane('waypointPane');
map.getPane('waypointPane').style.zIndex = 550;

L.control.layers(
  {
    "OpenStreetMap": osmLayer,
    "Thunderforest Transport": Thunderforest_Transport,
    "Google Streets": googleStreet,
    "Google Terrain": googleTer,
    "Google Hybrid": googleHybrid,
    "Google Satellite": googleSat,
    "Amap Streets": amapStreets,
    "Amap Satellite": amapSatellite
  },
  {
    "OpenAIP": openAIP
  }
).addTo(map);
// Canvas renderer
const canvasRenderer = L.canvas();

const aircrafts = new Map();
const PLANE_IMG = "https://i.ibb.co/6cNhyMMj/1.png";
let focusedAircraftId = null;
let flightPlanMarkers = [];

function clearFlightPlanMarkers() {
  flightPlanMarkers.forEach(m => map.removeLayer(m));
  flightPlanMarkers = [];
}

function makeDivIcon(data){
  const imgW=32,imgH=32,labelW=150,labelH=60,iconW=imgW+labelW,iconH=Math.max(imgH,labelH);
  const color=getAltitudeColor(data.alt);
  const isEmergency = data.squawk === '7700';
  const labelClass = isEmergency ? 'label emergency' : 'label';
  const squawkText = data.squawk ? `SQK:${escapeHtml(data.squawk)}` : '';
  const depShort = (data.departure||'').substring(0, 4);
  const arrShort = (data.arrival||'').substring(0, 4);
  
  return L.divIcon({
  html:`
    <div style="display:flex;align-items:center;width:${iconW}px;height:${iconH}px;">
      <img src="${PLANE_IMG}" width="${imgW}" height="${imgH}" style="transform:rotate(${data.heading||0}deg);"/>
      <div class="${labelClass} aircraft-tag" style="border-left:3px solid ${color};transition:background-color 0.2s ease;">
        <strong>${escapeHtml(data.callsign||'UNK')}</strong>
        <div style="font-size:11px;">
          ${escapeHtml(data.type||'??')} Â· <span style="color:${color};font-weight:bold;">${Math.round(data.alt||0)}ft</span> Â· ${formatSpeed(data.speed)}kt
        </div>
        <div style="font-size:11px;">${escapeHtml(data.flightNo||'')} ${escapeHtml(depShort)}â†’${escapeHtml(arrShort)}</div>
        ${squawkText ? `<div style="font-size:11px;font-weight:bold;color:#ffff00;">${squawkText}</div>` : ''}
      </div>
    </div>`,
  className:'leaflet-aircraft-icon',iconSize:[iconW,iconH],iconAnchor:[imgW/2,iconH/2]
});
}

function crossesIDL(lon1, lon2) {
  return Math.abs(lon1 - lon2) > 180;
}
function crossesTooFar(lat1, lon1, lat2, lon2, maxDistanceKm = 100) {
  return calculateDistance(lat1, lon1, lat2, lon2) > maxDistanceKm;
}

// è»Œè·¡
function showAircraftTrack(id) {
  const obj = aircrafts.get(id);
  if (!obj || !obj.rawPathForDisplay || obj.rawPathForDisplay.length === 0) return;
  clearAllAircraftTracks();
  const simplified = obj.rawPathForDisplay.map(p => [p[0], p[1], p[2], p[3]]);
  obj.displayPath = simplified;
  for (let i = 1; i < obj.displayPath.length; i++) {
    const prev = obj.displayPath[i-1];
    const curr = obj.displayPath[i];
    const alt = curr[2] || 0;
    if (crossesIDL(prev[1], curr[1]) || crossesTooFar(prev[0], prev[1], curr[0], curr[1])) continue;
    const seg = L.polyline(
      [ [prev[0], prev[1]], [curr[0], curr[1]] ],
      { renderer: canvasRenderer, color: getAltitudeColor(alt), weight: 2, opacity: 0.8 }
    ).addTo(map);
    seg.bindTooltip(`${Math.round(alt)} ft`, {
      sticky: true,
      direction: 'right',
      offset: [10, 0]
    });
    obj.segments.push(seg);
  }
}
function clearAllAircraftTracks() {
  for (const [id, obj] of aircrafts.entries()) {
    if (obj.segments && obj.segments.length > 0) {
      obj.segments.forEach(s => map.removeLayer(s));
      obj.segments = [];
    }
  }
}

// æ›´æ–°é£›æ©Ÿ
const aircraftMeta = new Map();
function ensureMeta(id) {
  if (!aircraftMeta.has(id)) {
    aircraftMeta.set(id, { lastRender: 0, pending: null });
  }
}

function updateAircraft(id, data, trackPoint = null) {
  ensureMeta(id);
  let paused = false;
  // å–å¾—å‰ä¸€æ¬¡è³‡æ–™
  let prev = null;
  if (aircrafts.has(id)) {
    prev = aircrafts.get(id).data;
  }

  // åˆ¤æ–·æ˜¯å¦æš«åœ
  function isPaused(prev, data) {
    if (!prev) return false;

    const dist = calculateDistance(prev.lat, prev.lon, data.lat, data.lon);

    // ä½æ–¼ 0.05 kmï¼ˆ50 å…¬å°ºï¼‰è¦–ç‚ºæ²’å‹•
    const tooSmallMove = dist < 0.05;

    const sameAlt = Math.abs(prev.alt - data.alt) < 5;     // é«˜åº¦å·®å°‘æ–¼ 5 ft è¦–ç‚ºä¸å‹•
    const sameSpeed = Math.abs(prev.speed - data.speed) < 1;
    const sameHead  = Math.abs(prev.heading - data.heading) < 1;

    return tooSmallMove && sameAlt && sameSpeed && sameHead;
  }


  // è¨­å®š paused ç‹€æ…‹
  if (aircrafts.has(id)) {
    aircrafts.get(id).paused = paused;
    const obj = aircrafts.get(id);
    const el = obj.marker.getElement && obj.marker.getElement();
    if (el) el.style.opacity = paused ? "0.3" : "1";
    if (paused) return; // ç›´æ¥ returnï¼Œä¸è¨˜éŒ„è³‡æ–™ã€ä¸æ›´æ–°
  }

  // åªæœ‰æ²’ paused æ™‚æ‰ push æ–°è³‡æ–™åˆ° rawTrack è·Ÿ rawPathForDisplay
  const latlng = [data.lat, data.lon];
  const color = getAltitudeColor(data.alt);
  const isEmergency = data.squawk === '7700';
  const labelClass = isEmergency ? 'label emergency' : 'label';
  const squawkText = data.squawk ? `SQK:${escapeHtml(data.squawk)}` : '';
  const now = Date.now();
  map.createPane('waypointPane');
  map.getPane('waypointPane').style.zIndex = 401;
  ensureMeta(id);
  if (aircrafts.has(id)) {
    const obj = aircrafts.get(id);
    obj.lastSeen = now;
    obj.data = data;
    if (!obj.paused) { // åªæœ‰æ²’ paused æ‰è¨˜éŒ„è³‡æ–™
      if (trackPoint) {
        if (!obj.rawTrack) obj.rawTrack = [];
        obj.rawTrack.push({lat: data.lat, lon: data.lon, ts: now, alt: data.alt, speed: data.speed});
        if (obj.rawTrack.length > 20000) obj.rawTrack.shift();
      }
      if (!obj.rawPathForDisplay) obj.rawPathForDisplay = [];
      obj.rawPathForDisplay.push([data.lat, data.lon, data.alt, data.speed]);
    }
    const meta = aircraftMeta.get(id);
    const elapsed = now - meta.lastRender;
    let shouldRender = false;
    if (elapsed >= 1000) shouldRender = true;
    else if (obj.displayPath && obj.displayPath.length > 0) {
      const prevPath = obj.displayPath[obj.displayPath.length-1];
      const d = calculateDistance(prevPath[0], prevPath[1], latlng[0], latlng[1]);
      if (d > 1) shouldRender = true;
    } else shouldRender = true;
    if (shouldRender && !meta.pending) {
      meta.pending = () => {
        const m = obj.marker;
        m.setLatLng(latlng);
        const el = m.getElement && m.getElement();
        if (el) {
          const img = el.querySelector('img');
          if (img) img.style.transform = `rotate(${data.heading || 0}deg)`;
          const label = el.querySelector('.label');
          if (label) {
            const depShort = (data.departure||'').substring(0, 4);
            const arrShort = (data.arrival||'').substring(0, 4);
            label.className = labelClass;
            label.innerHTML = `<strong>${escapeHtml(data.callsign||'UNK')}</strong>
              <div style="font-size:11px;">${escapeHtml(data.type||'??')} Â· <span style="color:${color};font-weight:bold;">${Math.round(data.alt||0)}ft</span> Â· ${formatSpeed(data.speed)}kt</div>
              <div style="font-size:11px;">${escapeHtml(data.flightNo||'')} ${escapeHtml(depShort)}â†’${escapeHtml(arrShort)}</div>
              ${squawkText ? `<div style="font-size:11px;font-weight:bold;color:#ffff00;">${squawkText}</div>` : ''}`;
            label.style.borderLeft = `3px solid ${color}`;
          }
        } else {
          m.setIcon(makeDivIcon(data));
        }
        meta.lastRender = Date.now();
        meta.pending = null;
        document.getElementById('connCount').textContent = aircrafts.size;
        if (id === focusedAircraftId) {
          showAircraftTrack(id);
        }
      };
      requestAnimationFrame(meta.pending);
    }
  } else {
    const marker = L.marker(latlng, {icon: makeDivIcon(data)}).addTo(map);
    marker.on('click', () => {
      clearAllAircraftTracks();
      focusedAircraftId = id;
      showAircraftTrack(id);
      showAircraftPanel(data, id);
      map.setView([data.lat, data.lon], map.getZoom(), {
    animate: true,
    duration: 0.5
  });
    });
    aircrafts.set(id, {
      marker,
      displayPath: trackPoint ? [[data.lat, data.lon, data.alt, data.speed]] : [],
      rawTrack: trackPoint ? [{lat:data.lat, lon:data.lon, ts:now, alt:data.alt, speed: data.speed}] : [],
      rawPathForDisplay: trackPoint ? [[data.lat, data.lon, data.alt, data.speed]] : [],
      segments: [],
      lastSeen: now,
      data,
      paused: false
    });
    aircraftMeta.get(id).lastRender = now;
  }
  if (id === focusedAircraftId) {
    showAircraftPanel(data, id);
  }
}
function removeAircraft(id) {
  if (aircrafts.has(id)) {
    const o = aircrafts.get(id);
    map.removeLayer(o.marker);
    o.segments.forEach(s => map.removeLayer(s));
    aircrafts.delete(id);
    document.getElementById('connCount').textContent = aircrafts.size;
  }
}

// Panel
function showAircraftPanel(data, id) {
  clearFlightPlanMarkers();
  let plan = data.flightPlan;
  if (typeof plan === 'string') {
    try {
      plan = JSON.parse(plan);
    } catch (err) {
      plan = null;
    }
  }
  if (plan && Array.isArray(plan) && plan.length) {
    const latlngs = [];
    plan.forEach((wp, i) => {
      const lat = Number(wp.lat),
          lon = Number(wp.lon);
      if (isNaN(lat) || isNaN(lon)) return;
      const label = wp.ident || wp.name || ('WP' + (i + 1));
      const waypointIcon = L.icon({
        iconUrl: 'https://i.ibb.co/VWH3qBpX/2.png',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        tooltipAnchor: [0, -12]
      });
      // åŠ å…¥ pane å±¬æ€§
      const m = L.marker([lat, lon], {
        icon: waypointIcon,
        pane: 'waypointPane'
      }).addTo(map).bindTooltip(label, {
        permanent: false,
        direction: 'top',
        className: 'waypoint-tooltip',
        offset: [0, -12]
      });
      flightPlanMarkers.push(m);
      latlngs.push([lat, lon]);
    });
    if (latlngs.length > 1) {
      // åŠ å…¥ pane å±¬æ€§
      const route = L.polyline(latlngs, {
        color: '#CEA5D5',
        weight: 4,
        opacity: 1,
        dashArray: '8 8',
        pane: 'waypointPane'
      }).addTo(map);
      flightPlanMarkers.push(route);
    }
  }
  
  let waypointsHtml = '';
  if (plan && Array.isArray(plan) && plan.length) {
    waypointsHtml = `<div style="margin-top:6px;"><strong>æœªä¾†èˆªé»:</strong>
      <ol style="margin:4px 0 0 16px;padding:0;font-size:12px;">${
        plan.map((wp, i) =>
          `<li>${escapeHtml(wp.ident || wp.name || ('WP'+(i+1)))} (${Number(wp.lat).toFixed(3)}, ${Number(wp.lon).toFixed(3)})${
            wp.alt ? ' @'+Math.round(Number(wp.alt))+'ft' : ''
          }</li>`
        ).join('')
      }</ol></div>`;
  }

  let p = document.getElementById('aircraftPanel');
  if (!p) {
    p = document.createElement('div');
    p.id = 'aircraftPanel';
    Object.assign(p.style, {
      position: 'absolute', top: '10px', right: '10px', width: '320px',
      background: '#1a1d29',
      color: '#fff',
      borderRadius: '12px', padding: '0',
      boxShadow: '0 8px 32px rgba(0,0,0,0.6)',
      fontSize: '13px', zIndex: 9999,
      fontFamily: 'Inter, "Noto Sans TC", Arial, sans-serif',
      overflow: 'hidden'
    });
    document.body.appendChild(p);
  }
  const c = getAltitudeColor(data.alt);
  const isEmergency = data.squawk === '7700';
  const emergencyBadge = isEmergency ? '<div style="background:#d32f2f;padding:8px;margin:-16px -16px 12px;font-weight:600;text-align:center;font-size:12px;letter-spacing:0.5px;">âš ï¸ EMERGENCY SQUAWK 7700</div>' : '';
  const depShort = (data.departure||'').substring(0, 4);
  const arrShort = (data.arrival||'').substring(0, 4);

  p.innerHTML = `
    <div style="background:linear-gradient(135deg, #2d3748 0%, #1a1d29 100%);padding:16px;border-bottom:1px solid #2d3748;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;">
        <h3 style="margin:0;font-size:24px;font-weight:700;color:#ffd93d;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0;">${escapeHtml(data.callsign || 'UNKNOWN')}</h3>
<button onclick="document.getElementById('aircraftPanel').remove();clearAllAircraftTracks();focusedAircraftId=null;clearFlightPlanMarkers();hideFlightChart();" style="background:transparent;border:none;color:#8b92a7;font-size:24px;cursor:pointer;padding:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.2s;flex-shrink:0;" onmouseover="this.style.background='#2d3748';this.style.color='#fff';" onmouseout="this.style.background='transparent';this.style.color='#8b92a7';">Ã—</button>
      </div>
      <div style="font-size:14px;color:#8b92a7;">${escapeHtml(data.flightNo || 'N/A')} Â· ${escapeHtml(data.type || 'Unknown Type')}</div>
    </div>
    ${emergencyBadge}
    <div style="padding:16px;">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;margin-bottom:16px;padding:12px;background:#0f1419;border-radius:8px;">
        <div style="text-align:center;">
          <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">FROM</div>
          <div style="font-size:18px;font-weight:700;color:#fff;">${escapeHtml(depShort || 'â€”')}</div>
        </div>
        <div style="color:#8b92a7;font-size:20px;">âœˆ</div>
        <div style="text-align:center;">
          <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">TO</div>
          <div style="font-size:18px;font-weight:700;color:#fff;">${escapeHtml(arrShort || 'â€”')}</div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div style="background:#0f1419;padding:12px;border-radius:8px;border-left:3px solid #4a9eff;">
          <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">ALTITUDE</div>
          <div style="font-size:20px;font-weight:700;color:#fff;">${Math.round(data.alt || 0)}</div>
          <div style="font-size:11px;color:#8b92a7;">feet</div>
        </div>
        <div style="background:#0f1419;padding:12px;border-radius:8px;border-left:3px solid #ffd93d;">
          <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">SPEED</div>
          <div style="font-size:20px;font-weight:700;color:#fff;">${formatSpeed(data.speed)}</div>
          <div style="font-size:11px;color:#8b92a7;">knots</div>
        </div>
      </div>
      
      <div style="background:#0f1419;padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">SQUAWK</div>
            <div style="font-size:16px;font-weight:600;color:${isEmergency ? '#ff4444' : '#fff'};">${escapeHtml(data.squawk || 'â€”')}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">HEADING</div>
            <div style="font-size:16px;font-weight:600;color:#fff;">${Math.round(data.heading || 0)}Â°</div>
          </div>
        </div>
      </div>
      
      ${data.takeoffTime ? `<div style="background:#0f1419;padding:12px;border-radius:8px;">
        <div style="font-size:11px;color:#8b92a7;margin-bottom:4px;">TAKEOFF TIME (UTC)</div>
        <div style="font-size:14px;font-weight:600;color:#fff;">${escapeHtml(data.takeoffTime)}</div>
      </div>` : ''}
    </div>`;
    // é¡¯ç¤ºé£›è¡Œè»Œè·¡åœ–è¡¨
  let trackArr = [];
  if (aircrafts.has(id)) {
    const obj = aircrafts.get(id);
    if (obj.rawTrack && obj.rawTrack.length > 2) {
      trackArr = obj.rawTrack; // ä¸åˆ‡ç‰‡ï¼Œå…¨éƒ¨éƒ½é¡¯ç¤º
    } else if (obj.rawPathForDisplay && obj.rawPathForDisplay.length > 2) {
      trackArr = obj.rawPathForDisplay.map(tp => ({
        alt: tp[2],
        speed: tp[3]
      }));
}
  }
  if (trackArr.length > 2) {
    showFlightChart(trackArr);
  } else {
    hideFlightChart();
  }
}
// Photo Map åŠŸèƒ½
let photoMapEnabled = false;
let photoMarkers = [];

const planeIcon = L.divIcon({
  html: '<div style="font-size: 24px;">âœˆï¸</div>',
  className: 'plane-marker',
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

function togglePhotoMap() {
  const btn = document.getElementById('photoMapToggle');
  photoMapEnabled = !photoMapEnabled;
  
  if (photoMapEnabled) {
    btn.classList.add('active');
    btn.textContent = 'ğŸ“ Hide Photos';
    loadPhotoMarkers();
  } else {
    btn.classList.remove('active');
    btn.textContent = 'ğŸ“ Photo Map';
    clearPhotoMarkers();
  }
}

function clearPhotoMarkers() {
  photoMarkers.forEach(marker => map.removeLayer(marker));
  photoMarkers = [];
}

async function loadPhotoMarkers() {
  try {
    const response = await fetch('/api/photos');
    const photos = await response.json();
    
    const photosWithLocation = photos.filter(photo => 
      photo.lat !== null && photo.lon !== null
    );
    
    photosWithLocation.forEach(photo => {
      const marker = L.marker([photo.lat, photo.lon], {
        icon: planeIcon,
        zIndexOffset: -1000 // ç¢ºä¿ç…§ç‰‡æ¨™è¨˜åœ¨é£›æ©Ÿæ¨™è¨˜ä¸‹æ–¹
      }).addTo(map);
      
      const popupContent = `
        <div class="photo-popup">
          <img src="${photo.thumb}" alt="${escapeHtml(photo.caption)}" onclick="window.open('${photo.file}', '_blank')">
          <h3>${escapeHtml(photo.caption)}</h3>
          <div class="info">ğŸ“· ${escapeHtml(photo.photographer)}</div>
          <div class="info">ğŸ“… ${new Date(photo.createdAt).toLocaleDateString('en-US')}</div>
          ${photo.tags && photo.tags.length > 0 ? `
            <div class="tags">
              ${photo.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      marker.bindPopup(popupContent, {
        maxWidth: 320
      });
      
      photoMarkers.push(marker);
    });
    
    console.log(`Loaded ${photoMarkers.length} photo markers`);
  } catch (error) {
    console.error('Failed to load photo markers:', error);
    alert('Failed to load photo locations. Please try again.');
  }
}
// WebSocket
// å®Œæ•´çš„ connectWS å‡½æ•¸
// åœ¨ atc.html ä¸­æ‰¾åˆ°ä¸¦å®Œæ•´æ›¿æ›æ•´å€‹ connectWS å‡½æ•¸

let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  
  ws.addEventListener('open', () => {
    ws.send(JSON.stringify({type: 'hello', role: 'atc'}));
  });
  
  ws.addEventListener('message', ev => {
    try {
      const m = JSON.parse(ev.data);
      
      // 1. å–®å€‹é£›æ©Ÿæ›´æ–°
      if (m.type === 'aircraft_update') {
        (Array.isArray(m.payload) ? m.payload : [m.payload]).forEach(a => 
          updateAircraft(a.id, a, m.trackPoint)
        );
      }
      
      // 2. å¿«ç…§ï¼ˆåˆå§‹é€£æ¥æ™‚çš„æ‰€æœ‰é£›æ©Ÿï¼‰
      else if (m.type === 'aircraft_snapshot') {
        m.payload.forEach(a => updateAircraft(a.id, a));
      }
      
      // 3. â­ æ–°å¢ï¼šæ‰¹æ¬¡æ›´æ–°è™•ç†
      else if (m.type === 'aircraft_batch_update') {
        console.log(`ğŸ“¦ Batch update: ${m.payload.length} aircraft`);
        m.payload.forEach(a => {
          updateAircraft(a.id, a, true);
        });
      }
      
      // 4. â­ ä¿®å¾©ï¼šæ­·å²è»Œè·¡è™•ç†
      else if (m.type === 'aircraft_track_history') {
        console.log('ğŸ“¥ Received track history:', m.payload);
        
        const { aircraftId, tracks } = m.payload;
        
        if (!tracks || tracks.length === 0) {
          console.warn(`âš ï¸ No tracks for ${aircraftId}`);
          return;
        }
        
        console.log(`âœˆï¸ Loading ${tracks.length} history points for ${aircraftId}`);

        // ç¢ºä¿ aircraft ç‰©ä»¶å­˜åœ¨
        if (!aircrafts.has(aircraftId)) {
          console.log(`âœ¨ Creating aircraft entry for ${aircraftId}`);
          const lastTrack = tracks[tracks.length - 1];
          const dummyData = {
            callsign: aircraftId,
            type: '??',
            lat: lastTrack.lat,
            lon: lastTrack.lon,
            alt: lastTrack.alt || 0,
            heading: 0,
            speed: lastTrack.speed || 0,
            squawk: '',
            flightNo: '',
            departure: '',
            arrival: '',
            takeoffTime: ''
          };
          
          const marker = L.marker([lastTrack.lat, lastTrack.lon], { 
            icon: makeDivIcon(dummyData) 
          }).addTo(map);

          marker.on('click', () => {
            clearAllAircraftTracks();
            focusedAircraftId = aircraftId;
            showAircraftTrack(aircraftId);
            showAircraftPanel(dummyData, aircraftId);
            map.setView([lastTrack.lat, lastTrack.lon], map.getZoom(), {
              animate: true,
              duration: 0.5
            });
          });

          aircrafts.set(aircraftId, {
            marker,
            path: [],
            rawTrack: [],
            rawPathForDisplay: [],
            displayPath: [],
            segments: [],
            lastSeen: Date.now(),
            data: dummyData,
            paused: false
          });
        }

        const obj = aircrafts.get(aircraftId);
        
        // åˆå§‹åŒ– rawTrack
        if (!obj.rawTrack) obj.rawTrack = [];
        
        // è½‰æ› history æ ¼å¼
        const historyArr = tracks.map(t => ({
          lat: t.lat,
          lon: t.lon,
          alt: t.alt || 0,
          speed: t.speed || 0,
          ts: t.ts || Date.now()
        }));
        
        // ç¢ºä¿æŒ‰æ™‚é–“æ’åº (èˆŠåˆ°æ–°)
        historyArr.sort((a, b) => a.ts - b.ts);
        
        console.log(`ğŸ“Š History range: ${new Date(historyArr[0].ts).toISOString()} to ${new Date(historyArr[historyArr.length-1].ts).toISOString()}`);

        // ğŸ”§ æ”¹é€²çš„æ™ºèƒ½åˆä½µç­–ç•¥
        if (obj.rawTrack.length === 0) {
          // æ²’æœ‰ç¾æœ‰æ•¸æ“š,ç›´æ¥ä½¿ç”¨ history
          console.log('ğŸ“‹ No existing track, using history directly');
          obj.rawTrack = historyArr;
        } else {
          // æœ‰ç¾æœ‰æ•¸æ“š,éœ€è¦åˆä½µ
          const existingOldest = obj.rawTrack[0].ts;
          const existingNewest = obj.rawTrack[obj.rawTrack.length - 1].ts;
          
          console.log(`ğŸ“Š Existing range: ${new Date(existingOldest).toISOString()} to ${new Date(existingNewest).toISOString()}`);
          
          // ğŸ†• æ”¹é€²:ä¿ç•™æ‰€æœ‰æ­·å²æ•¸æ“š,ä¸åªæ˜¯æ™‚é–“ç¯„åœå¤–çš„
          // ä½¿ç”¨ Map ä¾†å»é‡,å„ªå…ˆä¿ç•™æ­·å²æ•¸æ“š(æ›´å®Œæ•´)
          const mergedMap = new Map();
          
          // å…ˆåŠ å…¥æ­·å²æ•¸æ“š
          historyArr.forEach(point => {
            const key = `${point.ts}_${point.lat.toFixed(4)}_${point.lon.toFixed(4)}`;
            mergedMap.set(key, point);
          });
          
          // å†åŠ å…¥ç¾æœ‰æ•¸æ“š(å¦‚æœ key ä¸å­˜åœ¨æ‰åŠ å…¥)
          obj.rawTrack.forEach(point => {
            const key = `${point.ts}_${point.lat.toFixed(4)}_${point.lon.toFixed(4)}`;
            if (!mergedMap.has(key)) {
              mergedMap.set(key, point);
            }
          });
          
          // æŒ‰æ™‚é–“æ’åº
          obj.rawTrack = Array.from(mergedMap.values()).sort((a, b) => a.ts - b.ts);
          
          // ğŸ†• æª¢æ¸¬ä¸¦å¡«è£œæ™‚é–“é–“éš™
          const gaps = [];
          for (let i = 1; i < obj.rawTrack.length; i++) {
            const timeDiff = (obj.rawTrack[i].ts - obj.rawTrack[i-1].ts) / 1000; // ç§’
            if (timeDiff > 300) { // è¶…é5åˆ†é˜è¦–ç‚ºé–“éš™
              gaps.push({
                from: new Date(obj.rawTrack[i-1].ts).toISOString(),
                to: new Date(obj.rawTrack[i].ts).toISOString(),
                duration: Math.round(timeDiff / 60) + ' min'
              });
            }
          }
          
          if (gaps.length > 0) {
            console.warn(`âš ï¸ Detected ${gaps.length} time gaps:`, gaps);
          }
          
          console.log(`âœ… Merged to ${obj.rawTrack.length} unique points (was ${historyArr.length} + ${obj.rawTrack.length})`);
        }
      }
      
      // 5. æ¸…é™¤è»Œè·¡
      else if (m.type === 'aircraft_track_clear') {
        const { aircraftId } = m.payload;
        if (aircrafts.has(aircraftId)) {
          const obj = aircrafts.get(aircraftId);
          obj.segments.forEach(s => map.removeLayer(s));
          obj.segments = [];
          obj.rawTrack = [];
          obj.rawPathForDisplay = [];
          obj.displayPath = [];
          console.log(`ğŸ§¹ Cleared track for ${aircraftId}`);
        }
      }
      
      // 6. ç§»é™¤é£›æ©Ÿ
      else if (m.type === 'aircraft_remove') {
        m.payload.forEach(id => removeAircraft(id));
      }
      
    } catch (e) {
      console.error('âŒ Message parse error:', e);
    }
  });
  
  ws.addEventListener('close', () => {
    console.log('ğŸ”Œ WebSocket closed, reconnecting...');
    setTimeout(connectWS, 2000);
  });
  
  ws.addEventListener('error', (err) => {
    console.error('âŒ WebSocket error:', err);
    ws.close();
  });
}

connectWS();

function updateUTCTime() {
  const now = new Date();
  const utc = now.toISOString().replace('T', ' ').slice(0, 19);
  const el = document.getElementById('utcTimeText');
  if (el) el.textContent = utc;
}

function getTimeInTimeZone(tz) {
  try {
    const timeStr = new Date().toLocaleTimeString("en-US", {
      hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit", timeZone: tz
    });
    const [h, m, s] = timeStr.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m, s, 0);
    return d;
  } catch (e) {
    return new Date();
  }
}

function rotateClock(svg, now) {
  const hour = svg.querySelector("line[id$='-hour']");
  const minute = svg.querySelector("line[id$='-minute']");
  if (!hour || !minute) return;
  const h = now.getHours() % 12, m = now.getMinutes();
  hour.setAttribute("transform", `rotate(${h * 30 + m * 0.5} 20 20)`);
  minute.setAttribute("transform", `rotate(${m * 6} 20 20)`);
}

function createClockSVG(id, label, timeZone) {
  const container = document.createElement("div");
  container.style.textAlign = "center";
  container.style.fontSize = "10px";
  container.innerHTML = `<div style="margin-bottom: 4px; font-weight: bold;">${label}</div>`;
  
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "40");
  svg.setAttribute("height", "40");
  svg.setAttribute("viewBox", "0 0 40 40");
  
  let hourNow = 12;
  try {
    const tStr = new Date().toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", timeZone });
    hourNow = parseInt(tStr, 10);
  } catch {}
  
  const isDay = hourNow >= 6 && hourNow < 18;
  const clockFaceURL = isDay
    ? "https://clock-day.short.gy/0Fxzwe"
    : "https://clock-day.short.gy/2ZpDoNight";
  const pointerColor = isDay ? "black" : "white";

  svg.innerHTML = `
    <defs>
      <clipPath id="clockClip-${id}">
        <circle cx="20" cy="20" r="18"/>
      </clipPath>
      <g id="clockHands-${id}">
        <line id="${id}-hour" x1="20" y1="20" x2="20" y2="11" stroke="${pointerColor}" stroke-width="2"/>
        <line id="${id}-minute" x1="20" y1="20" x2="20" y2="7" stroke="${pointerColor}" stroke-width="1"/>
      </g>
    </defs>
    <image href="${clockFaceURL}" x="0" y="0" width="40" height="40" clip-path="url(#clockClip-${id})"/>
    <use href="#clockHands-${id}"/>
  `;
  
  container.appendChild(svg);
  return container;
}

function initializeClocks() {
  const clockContainer = document.getElementById('clockContainer');
  if (!clockContainer) return;
  
  const utcClock = createClockSVG("utc", "UTC", "UTC");
  clockContainer.appendChild(utcClock);
  rotateClock(utcClock, getTimeInTimeZone("UTC"));
  
  const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const localClock = createClockSVG("local", "Local", localTz);
  clockContainer.appendChild(localClock);
  rotateClock(localClock, getTimeInTimeZone(localTz));
  
  setInterval(() => {
    rotateClock(utcClock, getTimeInTimeZone("UTC"));
    rotateClock(localClock, getTimeInTimeZone(localTz));
  }, 1000);
}

setInterval(updateUTCTime, 1000);
updateUTCTime();
initializeClocks();
</script>
</body>
</html>
