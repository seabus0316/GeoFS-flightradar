<!doctype html>
<html lang="zh-Hant">
<head>
  <meta name="google-site-verification" content="Ss-BjkX0hVH_hO107C5YcoDD55wmd25bM2zXCM6ZCnA" />
  <meta charset="utf-8" />
  <title>GeoFS-Flightradar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="/styles.css">
</head>
<body>
<!-- Search Box -->
<div id="searchBox" style="position: fixed; top: 20px; left: 50px; z-index: 99999; width: 240px;">
  <div style="position: relative;">
    <input type="text" id="searchInput" placeholder="ğŸ” Search flight or airport..." 
           style="width: 100%; padding: 12px 45px 12px 16px; font-size: 14px; border: none; border-radius: 8px; 
                  background: rgba(255, 255, 255, 0.95); box-shadow: 0 2px 12px rgba(0,0,0,0.2); 
                  outline: none; font-family: 'Inter', sans-serif;">
    <button id="clearSearch" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
                                     background: none; border: none; font-size: 18px; color: #999; cursor: pointer; display: none;">âœ•</button>
  </div>
  <div id="searchResults" style="display: none; margin-top: 6px; background: white; border-radius: 8px; 
                                 box-shadow: 0 2px 12px rgba(0,0,0,0.2); max-height: 400px; overflow-y: auto;"></div>
</div>

  <!-- Photo Map Toggle Button -->
<button id="photoMapToggle" onclick="togglePhotoMap()">ğŸ“ Photo Map</button>
  <!-- å´é‚Šç…§ç‰‡é¢æ¿ -->
<button id="photoToggle" onclick="togglePhotoSidebar()">ğŸ“·</button>
<div id="photoSidebar">
  <h3 style="color:#58a6ff;margin-top:0;">JetPhotos Gallery</h3>
  <div id="photoPanel"></div>
</div>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<div class="github-ribbon">
  <a href="https://github.com/seabus0316/GeoFS-flightradar/tree/main" target="_blank">
    Visit GitHub Page
  </a>
</div>
<div class="social-buttons">
  <a href="https://discord.gg/YKfdMHPC2Y" class="social-btn discord-btn" target="_blank">
    <img src="https://cdn.prod.website-files.com/6257adef93867e50d84d30e2/66e3d7f4ef6498ac018f2c55_Symbol.svg" alt="Discord" style="width: 30px; height: 30px;">
  </a>
</div>
<div id="map"></div>
<div class="legend">GeoFS ATC â€” connected: <span id="connCount">0</span></div>
<div class="altitude-legend">
  <div style="font-weight:bold;margin-bottom:4px;">é«˜åº¦åœ–ä¾‹</div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffffff;"></div><span>&lt;100m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffff00;"></div><span>100m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00ff00;"></div><span>~1000m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00bfff;"></div><span>2500m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#0000ff;"></div><span>é«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#800080;"></div><span>æ¥µé«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ff0000;"></div><span>æœ€é«˜ç©º</span></div>
</div>

<!-- UTC Time Box with Clocks -->
<div id="utcTime" style="position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.85); color: white; padding: 12px; border-radius: 8px; font-size: 14px; font-family: Arial, sans-serif; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.5);">
  <div style="margin-bottom: 8px; font-weight: bold;">UTC Time: <span id="utcTimeText">--</span></div>
  <div id="clockContainer" style="display: flex; gap: 15px; justify-content: center;">
    <!-- Clocks will be inserted here -->
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>
<script>
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
// Chart.js ä»¿ Flightradar24 é¢¨æ ¼
const FLIGHT_STATUS_IMAGES = {
     'takeoff': 'https://i.ibb.co/VpzRv10F/departure.png',
     'cruise': 'https://i.ibb.co/ywrJMZN/plane.png',
     'landing': 'https://i.ibb.co/bg2LGTTR/landing.png',
     'descending': 'https://i.ibb.co/bg2LGTTR/landing.png', 
     'unknown': 'https://i.ibb.co/Rpc7Jk13/refresh-cw-off.png', 
     'ground': 'https://i.ibb.co/wZn8KNYD/plane.png'
   };
// èˆªç©ºå…¬å¸è³‡æ–™åº«
let airlinesData = {};

// è¼‰å…¥èˆªç©ºå…¬å¸è³‡æ–™
async function loadAirlines() {
  try {
    const response = await fetch('/airlines.json');
    if (!response.ok) throw new Error('Failed to fetch airlines');
    airlinesData = await response.json();
    console.log('âœ… Loaded', Object.keys(airlinesData).length, 'airlines');
  } catch (error) {
    console.error('Failed to load airlines:', error);
  }
}

// æ ¹æ“š callsign æˆ– flightNo è­˜åˆ¥èˆªç©ºå…¬å¸
function getAirlineInfo(callsign, flightNo) {
  if (!callsign && !flightNo) return null;
  
  // å„ªå…ˆä½¿ç”¨ callsign (ICAO code)
  if (callsign) {
    // æå–å‰3å€‹å­—æ¯ä½œç‚º ICAO code
    const icaoCode = callsign.substring(0, 3).toUpperCase();
    if (airlinesData[icaoCode]) {
      return {
        name: airlinesData[icaoCode].name,
        icao: airlinesData[icaoCode].icao,
        iata: airlinesData[icaoCode].iata,
        logo: airlinesData[icaoCode].logo,
        country: airlinesData[icaoCode].country
      };
    }
  }
  
  // å¦‚æœ callsign æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç”¨ flightNo (IATA code)
  if (flightNo) {
    // æå–å‰2-3å€‹å­—æ¯ä½œç‚º IATA code
    const iataMatch = flightNo.match(/^([A-Z]{2,3})/);
    if (iataMatch) {
      const iataCode = iataMatch[1];
      // åœ¨è³‡æ–™åº«ä¸­æœå°‹å°æ‡‰çš„ IATA code
      for (const icao in airlinesData) {
        if (airlinesData[icao].iata === iataCode) {
          return {
            name: airlinesData[icao].name,
            icao: airlinesData[icao].icao,
            iata: airlinesData[icao].iata,
            logo: airlinesData[icao].logo,
            country: airlinesData[icao].country
          };
        }
      }
    }
  }
  
  return null;
}
// è³‡æ–™æŠ½ç¨€å‡½æ•¸ - æ”¹é€²ç‰ˆ
function simplifyTrackData(track, maxPoints = 300) {
  if (track.length <= maxPoints) return track;
  
  // è¨ˆç®—æ™‚é–“è·¨åº¦
  const firstTs = track[0]?.ts;
  const lastTs = track[track.length - 1]?.ts;
  
  if (!firstTs || !lastTs) {
    // å¦‚æœæ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œä½¿ç”¨èˆŠæ–¹æ³•
    const step = Math.ceil(track.length / maxPoints);
    const simplified = [];
    for (let i = 0; i < track.length; i += step) {
      simplified.push(track[i]);
    }
    if (simplified[simplified.length - 1] !== track[track.length - 1]) {
      simplified.push(track[track.length - 1]);
    }
    return simplified;
  }
  
  const timeSpan = lastTs - firstTs;
  const targetInterval = timeSpan / maxPoints;
  
  const simplified = [track[0]]; // ä¿ç•™ç¬¬ä¸€å€‹é»
  let lastTime = firstTs;
  
  for (let i = 1; i < track.length - 1; i++) {
    const point = track[i];
    const timeDiff = point.ts - lastTime;
    const altChange = Math.abs(point.alt - track[i-1].alt);
    const speedChange = Math.abs(point.speed - track[i-1].speed);
    
    // æ™‚é–“é–“éš”è¶³å¤ ï¼Œæˆ–é«˜åº¦/é€Ÿåº¦è®ŠåŒ–å¤§å°±ä¿ç•™
    if (timeDiff >= targetInterval || altChange > 500 || speedChange > 50) {
      simplified.push(point);
      lastTime = point.ts;
    }
  }
  
  simplified.push(track[track.length - 1]); // ä¿ç•™æœ€å¾Œä¸€å€‹é»
  
  return simplified;
}

function showFlightChart(track) {
  const container = document.getElementById('flightChartContainer');
  container.style.display = 'block';
  const ctx = document.getElementById('flightChart').getContext('2d');

  // è³‡æ–™æŠ½ç¨€è™•ç†
  const simplifiedTrack = simplifyTrackData(track, 200);
  
  // è¨ˆç®—æ™‚é–“è·¨åº¦ï¼Œå‹•æ…‹èª¿æ•´æ¨™ç±¤æ ¼å¼
  const firstTs = simplifiedTrack[0]?.ts;
  const lastTs = simplifiedTrack[simplifiedTrack.length - 1]?.ts;
  const timeSpanHours = firstTs && lastTs ? (lastTs - firstTs) / (1000 * 60 * 60) : 0;
  
  // æ ¹æ“šæ™‚é–“è·¨åº¦é¸æ“‡æ ¼å¼
  let timeFormat;
  let maxTicks;
  if (timeSpanHours > 6) {
    // è¶…é 6 å°æ™‚ï¼šåªé¡¯ç¤ºå°æ™‚
    timeFormat = { hour: '2-digit', hour12: false };
    maxTicks = 12;
  } else if (timeSpanHours > 2) {
    // 2-6 å°æ™‚ï¼šé¡¯ç¤ºå°æ™‚:åˆ†é˜ï¼ˆæ¯ 30 åˆ†é˜ï¼‰
    timeFormat = { hour: '2-digit', minute: '2-digit', hour12: false };
    maxTicks = 15;
  } else {
    // å°‘æ–¼ 2 å°æ™‚ï¼šé¡¯ç¤ºè©³ç´°æ™‚é–“
    timeFormat = { hour: '2-digit', minute: '2-digit', hour12: false };
    maxTicks = 12;
  }

  // X è»¸æ¨™ç±¤ - ä½¿ç”¨æŠ½ç¨€å¾Œçš„è³‡æ–™
  const labels = simplifiedTrack.map((p, i) => {
    if (p.ts) {
      const dt = new Date(p.ts);
      return dt.toLocaleTimeString('en-GB', timeFormat);
    }
    return i + 1;
  });
  
  const altitudes = simplifiedTrack.map(p => Math.round(p.alt));
  const speeds = simplifiedTrack.map(p => Math.round(formatSpeed(p.speed)));

  if (!flightChartObj) {
    flightChartObj = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Ground Speed',
            data: speeds,
            borderColor: '#ffd300',
            backgroundColor: 'rgba(255,211,0,0.07)',
            pointRadius: 0, // é—œé–‰é»ï¼Œè®“ç·šæ›´æ¸…æ™°
            yAxisID: 'y-speed',
            tension: 0.25
          },
          {
            label: 'Altitude',
            data: altitudes,
            borderColor: '#00b4ff',
            backgroundColor: 'rgba(0,180,255,0.07)',
            pointRadius: 0, // é—œé–‰é»
            yAxisID: 'y-alt',
            tension: 0.25
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
       plugins: {
          legend: {
            display: true,
            labels: {
              color: "#fff",
              font: { family: 'Inter', size: 14, weight: 'bold' }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: "#222",
            borderColor: "#ffd300",
            borderWidth: 2,
            callbacks: {
              title: (items) => {
                const idx = items[0].dataIndex;
                const p = simplifiedTrack[idx];
                if (p.ts)
                  return new Date(p.ts).toLocaleString('en-GB', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                  });
                return `Point ${idx+1}`;
              },
              label: (item) => {
                if (item.dataset.label === "Ground Speed")
                  return `Ground Speed: ${item.formattedValue} kt`;
                else
                  return `Altitude: ${item.formattedValue} ft`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: false },
            ticks: {
              color: "#fff",
              font: { size: 11 },
              maxRotation: 45,
              minRotation: 0,
              autoSkip: true,
              maxTicksLimit: maxTicks, // å‹•æ…‹èª¿æ•´
              display: true
            },
            grid: { color: "#444" },
            display: true
          },
          'y-alt': {
            type: 'linear',
            position: 'left',
            title: {
              display: true,
              text: 'Altitude (ft)',
              color: "#00b4ff",
              font: { size: 13, weight:'bold' }
            },
            grid: { color: "#444" },
            ticks: { color: "#00b4ff", font: { size: 13 } }
          },
          'y-speed': {
            type: 'linear',
            position: 'right',
            title: {
              display: true,
              text: 'Speed (kt)',
              color: "#ffd300",
              font: { size: 13, weight:'bold' }
            },
            grid: { drawOnChartArea: false },
            ticks: { color: "#ffd300", font: { size: 13 } }
          }
        }
      }
    });
  } else {
    // å¹³æ»‘æ›´æ–°è³‡æ–™
    const simplifiedTrack = simplifyTrackData(track, 200);
    const labels = simplifiedTrack.map((p, i) => {
      if (p.ts) {
        const dt = new Date(p.ts);
        return dt.toLocaleTimeString('en-GB', timeFormat);
      }
      return i + 1;
    });
    const speeds = simplifiedTrack.map(p => Math.round(formatSpeed(p.speed)));
    const altitudes = simplifiedTrack.map(p => Math.round(p.alt));
    
    flightChartObj.data.labels = labels;
    flightChartObj.data.datasets[0].data = speeds;
    flightChartObj.data.datasets[1].data = altitudes;
    flightChartObj.options.scales.x.ticks.maxTicksLimit = maxTicks; // æ›´æ–° maxTicks
    flightChartObj.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼åŠ å¿«æ›´æ–°é€Ÿåº¦
  }
}
function hideFlightChart() {
  document.getElementById('flightChartContainer').style.display = 'none';
  if (flightChartObj) {
    flightChartObj.destroy();
    flightChartObj = null;
  }
}
// å·¥å…·å‡½å¼
function getAltitudeColor(altFt) {
  const alt = altFt || 0;
  if (alt < 330) return "#ffffff";
  if (alt < 3300) return "#ffff00";
  if (alt < 8200) return "#00ff00";
  if (alt < 20000) return "#00bfff";
  if (alt < 30000) return "#0000ff";
  if (alt < 40000) return "#800080";
  return "#ff0000";
}
function formatSpeed(speedRaw) {
  if (typeof speedRaw !== 'number') return '---';
  let speed = speedRaw;
  if (speedRaw < 50) speed = speedRaw * 1.94384;
  return Math.round(speed);
}
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, function(c) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[c];
  });
}
// ç…§ç‰‡å´é‚Šæ¬„åˆ‡æ›
function togglePhotoSidebar() {
  const sidebar = document.getElementById('photoSidebar');
  sidebar.classList.toggle('open');
}

// è¼‰å…¥ç…§ç‰‡ï¼ˆä¿®æ”¹åŸæœ‰çš„ fetch éƒ¨åˆ†ï¼‰
fetch('/api/photos')
  .then(r => r.json())
  .then(list => {
    const panel = document.getElementById('photoPanel');
    panel.innerHTML = '';
    list.forEach(p => {
      const item = document.createElement('div');
      item.className = 'photo-item';
      item.innerHTML = `
      <img src="${p.thumb}" alt="${p.caption || ''}" loading="lazy" onclick="window.open('${p.thumb}', '_blank')">
      <div class="caption">
        <strong>${p.caption || 'Untitled'}</strong><br>
        <small>ğŸ“¸ ${p.photographer || 'Anonymous'}</small>
      </div>
`;
      panel.appendChild(item);
    });
  })
  .catch(err => console.error('è¼‰å…¥ç…§ç‰‡å¤±æ•—:', err));
// åœ°åœ–è¨­å®š
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
});
const Thunderforest_Transport = L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}{r}.png?apikey=7e63f2f7d95e4361ae0c15d5ab9b7f99', {
  attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
});
const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleHybrid = L.tileLayer('https://mt0.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});
const googleTer = L.tileLayer('http://mt0.google.com/vt/lyrs=p&hl=en&x={x}&y={y}&z={z}', {
  attribution: 'Map data &copy; Google'
});

// é«˜å¾·åœ°å›¾ (Amap)
const amapStreets = L.tileLayer(
  'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',
  {
    subdomains: "1234",
    attribution: '&copy; <a href="https://www.amap.com/">é«˜å¾·åœ°å›¾</a>'
  }
);

const amapSatellite = L.tileLayer(
  'https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
  {
    subdomains: "1234",
    attribution: '&copy; <a href="https://www.amap.com/">é«˜å¾·åœ°å›¾å«æ˜Ÿ</a>'
  }
);

const openAIP = L.tileLayer(
  'https://api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=409a25682b90c26541b6c25493950e17',
  {
    attribution: '&copy; <a href="https://www.openaip.net/">OpenAIP</a>',
    maxZoom: 18,
    maxNativeZoom: 14,
    transparent: true,
    opacity: 0.8
  }
);
const OWM_API_KEY = 'f722a584c22e1ec243fb71d8f329ccd0'; // è«‹æ›¿æ›æˆä½ çš„ Key

const owmAttrib = '&copy; <a href="https://openweathermap.org">OpenWeatherMap</a>';

const owmClouds = L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${OWM_API_KEY}`, {
  attribution: '&copy; <a href="https://openweathermap.org">OpenWeatherMap</a>',
  opacity: 0.5 // å»ºè­°è¨­ç½®é€æ˜åº¦ï¼Œæ‰èƒ½çœ‹åˆ°åº•åœ–
});

const owmPrecipitation = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_API_KEY}`, {
  attribution: '&copy; <a href="https://openweathermap.org">OpenWeatherMap</a>',
  opacity: 0.5
});

const owmWind = L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${OWM_API_KEY}`, {
  attribution: '&copy; <a href="https://openweathermap.org">OpenWeatherMap</a>',
  opacity: 0.5
});
const map = L.map('map', {
  worldCopyJump: false,
  maxZoom: 18,
  minZoom: 2,
  maxBounds: [[-85, -360], [85, 360]],
  layers: [googleSat,openAIP]
}).setView([20,0],2);

// æ–°å¢ waypointPane (z-index æ¯” tilePaneé«˜,æ¯”overlayPaneä½)
map.createPane('waypointPane');
map.getPane('waypointPane').style.zIndex = 550;

L.control.layers(
  {
    "OpenStreetMap": osmLayer,
    "Thunderforest Transport": Thunderforest_Transport,
    "Google Streets": googleStreet,
    "Google Terrain": googleTer,
    "Google Hybrid": googleHybrid,
    "Google Satellite": googleSat,
    "Amap Streets": amapStreets,
    "Amap Satellite": amapSatellite
  },
  {
    "OpenAIP": openAIP,
    "OWM Clouds": owmClouds,          // æ–°å¢
    "OWM Precipitation": owmPrecipitation,   // æ–°å¢
    "OWM Wind": owmWind
  }
).addTo(map);
// Canvas renderer
const canvasRenderer = L.canvas();

const aircrafts = new Map();
const PLANE_IMG = "https://i.ibb.co/6cNhyMMj/1.png";
const NEXT_WAYPOINT_IMG = "https://i.ibb.co/4ZTy2Gds/watpoint.png"; 
let focusedAircraftId = null;
let flightPlanMarkers = [];
let nextWaypointMarker = null;

function clearFlightPlanMarkers() {
  flightPlanMarkers.forEach(m => map.removeLayer(m));
  flightPlanMarkers = [];
    if (nextWaypointMarker) {
    map.removeLayer(nextWaypointMarker);
    nextWaypointMarker = null;
  }
}

function makeDivIcon(data){
  const imgW=32,imgH=32,labelW=150,labelH=60,iconW=imgW+labelW,iconH=Math.max(imgH,labelH);
  const color=getAltitudeColor(data.alt);
  const isEmergency = data.squawk === '7700';
  const labelClass = isEmergency ? 'label emergency' : 'label';
  const squawkText = data.squawk ? `SQK:${escapeHtml(data.squawk)}` : '';
  const depShort = (data.departure||'').substring(0, 4);
  const arrShort = (data.arrival||'').substring(0, 4);
  
  return L.divIcon({
  html:`
    <div style="display:flex;align-items:center;width:${iconW}px;height:${iconH}px;">
      <img src="${PLANE_IMG}" width="${imgW}" height="${imgH}" style="transform:rotate(${data.heading||0}deg);"/>
      <div class="${labelClass} aircraft-tag" style="border-left:3px solid ${color};transition:background-color 0.2s ease;">
        <strong>${escapeHtml(data.callsign||'UNK')}</strong>
        <div style="font-size:11px;">
          ${escapeHtml(data.type||'??')} Â· <span style="color:${color};font-weight:bold;">${Math.round(data.alt||0)}ft</span> Â· ${formatSpeed(data.speed)}kt
        </div>
        <div style="font-size:11px;">${escapeHtml(data.flightNo||'')} ${escapeHtml(depShort)}â†’${escapeHtml(arrShort)}</div>
        ${squawkText ? `<div style="font-size:11px;font-weight:bold;color:#ffff00;">${squawkText}</div>` : ''}
      </div>
    </div>`,
  className:'leaflet-aircraft-icon',iconSize:[iconW,iconH],iconAnchor:[imgW/2,iconH/2]
});
}

function crossesIDL(lon1, lon2) {
  return Math.abs(lon1 - lon2) > 180;
}
function crossesTooFar(lat1, lon1, lat2, lon2, maxDistanceKm = 100) {
  return calculateDistance(lat1, lon1, lat2, lon2) > maxDistanceKm;
}
// å¾å¾Œç«¯è¼‰å…¥æ­·å²è»Œè·¡
async function loadHistoryFromBackend(aircraftId) {
  try {
    // è¨­å®šè¦è¼‰å…¥çš„æ™‚é–“ç¯„åœï¼ˆä¾‹å¦‚ï¼šæœ€è¿‘ 6 å°æ™‚ï¼‰
    const hoursBack = 6;
    const startTime = Date.now() - (hoursBack * 60 * 60 * 1000);
    
    const response = await fetch(`/api/tracks/${aircraftId}?start=${startTime}`);
    if (!response.ok) {
      console.warn('Failed to load history:', response.status);
      return null;
    }
    
    const historyData = await response.json();
    return historyData;
  } catch (error) {
    console.error('Error loading history:', error);
    return null;
  }
}

// è¼‰å…¥æ‰€æœ‰ç•¶å‰é£›æ©Ÿçš„æ­·å²è»Œè·¡
async function loadAllHistoryFromBackend() {
  try {
    const hoursBack = 6;
    const startTime = Date.now() - (hoursBack * 60 * 60 * 1000);
    
    const response = await fetch(`/api/tracks/all?start=${startTime}`);
    if (!response.ok) {
      console.warn('Failed to load all history:', response.status);
      return;
    }
    
    const allTracks = await response.json();
    
    // å°‡æ­·å²è³‡æ–™åˆä½µåˆ°ç¾æœ‰é£›æ©Ÿ
    for (const [aircraftId, tracks] of Object.entries(allTracks)) {
      if (aircrafts.has(aircraftId)) {
        const obj = aircrafts.get(aircraftId);
        if (!obj.rawTrack) obj.rawTrack = [];
        if (!obj.rawPathForDisplay) obj.rawPathForDisplay = [];
        
        // åˆä½µæ­·å²è³‡æ–™ï¼ˆé¿å…é‡è¤‡ï¼‰
        const existingTimestamps = new Set(obj.rawTrack.map(t => t.ts));
        
        tracks.forEach(t => {
          if (!existingTimestamps.has(t.ts)) {
            obj.rawTrack.push({
              lat: t.lat,
              lon: t.lon,
              alt: t.alt || 0,
              speed: t.speed || 0,
              ts: t.ts
            });
            obj.rawPathForDisplay.push([t.lat, t.lon, t.alt || 0, t.speed || 0]);
          }
        });
        
        // æŒ‰æ™‚é–“æ’åº
        obj.rawTrack.sort((a, b) => a.ts - b.ts);
        
        // é™åˆ¶ç¸½æ•¸é‡
        if (obj.rawTrack.length > 10000) {
          obj.rawTrack = obj.rawTrack.slice(-10000);
        }
        if (obj.rawPathForDisplay.length > 10000) {
          obj.rawPathForDisplay = obj.rawPathForDisplay.slice(-10000);
        }
      }
    }
    
    console.log(`âœ… Loaded history for ${Object.keys(allTracks).length} aircraft`);
  } catch (error) {
    console.error('Error loading all history:', error);
  }
}
// è»Œè·¡
function showAircraftTrack(id) {
  const obj = aircrafts.get(id);
  if (!obj || !obj.rawPathForDisplay || obj.rawPathForDisplay.length === 0) return;
  clearAllAircraftTracks();
  const simplified = obj.rawPathForDisplay.map(p => [p[0], p[1], p[2], p[3]]);
  obj.displayPath = simplified;
  for (let i = 1; i < obj.displayPath.length; i++) {
    const prev = obj.displayPath[i-1];
    const curr = obj.displayPath[i];
    const alt = curr[2] || 0;
    if (crossesIDL(prev[1], curr[1]) || crossesTooFar(prev[0], prev[1], curr[0], curr[1])) continue;
    const seg = L.polyline(
      [ [prev[0], prev[1]], [curr[0], curr[1]] ],
      { renderer: canvasRenderer, color: getAltitudeColor(alt), weight: 2, opacity: 0.8 }
    ).addTo(map);
    seg.bindTooltip(`${Math.round(alt)} ft`, {
      sticky: true,
      direction: 'right',
      offset: [10, 0]
    });
    obj.segments.push(seg);
  }
}
function clearAllAircraftTracks() {
  for (const [id, obj] of aircrafts.entries()) {
    if (obj.segments && obj.segments.length > 0) {
      obj.segments.forEach(s => map.removeLayer(s));
      obj.segments = [];
    }
  }
}

// é£›è¡Œç‹€æ…‹é æ¸¬å‡½æ•¸ - æ–°é‚è¼¯
function predictFlightStatus(data, prev) {
  const altAGL = data.alt || 0; // å‡è¨­ alt å·²ç¶“æ˜¯ AGL (Above Ground Level)
  const speed = formatSpeed(data.speed);
  
  // è¨ˆç®—å‚ç›´é€Ÿåº¦ (vspeed) - å–®ä½: ft/min
  let vspeed = 0;
  if (prev && prev.alt !== undefined && prev.ts && data.ts) {
    const timeDiff = (data.ts - prev.ts) / 60000; // è½‰æ›ç‚ºåˆ†é˜
    if (timeDiff > 0) {
      vspeed = (data.alt - prev.alt) / timeDiff;
    }
  }
  
  // åˆ¤æ–·é£›è¡Œéšæ®µ
  const isOnGround = altAGL < 100;
  const isClimbing = vspeed > 200;
  const isDescending = vspeed < -200;
  const hasFlightPlan = data.flightPlan && data.flightPlan.length > 0;
  
  // åœ°é¢
  if (isOnGround) {
    return { status: 'ground', text: 'On Ground', color: '#9E9E9E', image: FLIGHT_STATUS_IMAGES.ground };
  }
  
  // çˆ¬å‡
  if (isClimbing) {
    return { status: 'climbing', text: 'Climbing', color: '#4CAF50', image: FLIGHT_STATUS_IMAGES.takeoff };
  }
  
  // ä¸‹é™/é™è½
  if (isDescending) {
    if (hasFlightPlan && altAGL < 5000) {
      return { status: 'landing', text: 'Landing', color: '#FF9800', image: FLIGHT_STATUS_IMAGES.landing };
    }
    return { status: 'descending', text: 'Descending', color: '#FFA726', image: FLIGHT_STATUS_IMAGES.landing };
  }
  
  // å·¡èˆª
  if (altAGL > 5000) {
    return { status: 'cruising', text: 'Cruising', color: '#2196F3', image: FLIGHT_STATUS_IMAGES.cruise };
  }
  
  // æœªçŸ¥ç‹€æ…‹
  return { status: 'unknown', text: 'In Flight', color: '#2196F3', image: FLIGHT_STATUS_IMAGES.cruise };
}
// æ›´æ–°é£›æ©Ÿ
const aircraftMeta = new Map();
function ensureMeta(id) {
  if (!aircraftMeta.has(id)) {
    aircraftMeta.set(id, { lastRender: 0, pending: null });
  }
}

function updateAircraft(id, data, trackPoint = null) {
  // 1. å–å¾—æˆ–å»ºç«‹é£›æ©Ÿç‰©ä»¶
  let isNew = false;
  const now = Date.now();
  
  if (!aircrafts.has(id)) {
    isNew = true;
    // æ–°é£›æ©Ÿï¼šç›´æ¥å»ºç«‹ Marker
    const marker = L.marker([data.lat, data.lon], {icon: makeDivIcon(data)}).addTo(map);
    
    // é»æ“Šäº‹ä»¶
    marker.on('click', async () => {
      clearAllAircraftTracks();
      focusedAircraftId = id;
      showAircraftTrack(id);
      showAircraftPanel(data, id);
      
      const history = await loadHistoryFromBackend(id);
      if (history && history.tracks) {
        const obj = aircrafts.get(id);
        if (obj) {
          obj.rawTrack = [];
          obj.rawPathForDisplay = [];
          history.tracks.forEach(t => {
            obj.rawTrack.push({lat: t.lat, lon: t.lon, alt: t.alt||0, speed: t.speed||0, ts: t.ts});
            obj.rawPathForDisplay.push([t.lat, t.lon, t.alt||0, t.speed||0]);
          });
          showAircraftTrack(id);
        }
      }
      map.setView([data.lat, data.lon], map.getZoom(), {animate: true});
    });

    aircrafts.set(id, {
      marker,
      displayPath: [],
      rawTrack: trackPoint ? [{lat:data.lat, lon:data.lon, ts:now, alt:data.alt, speed:data.speed}] : [],
      rawPathForDisplay: trackPoint ? [[data.lat, data.lon, data.alt, data.speed]] : [],
      segments: [],
      lastSeen: now,
      data: data,
      paused: false,
      lastPacketTs: now // ç”¨æ–¼è¨ˆç®—å‹•ç•«æ™‚é–“
    });
  }

  // 2. è™•ç†è³‡æ–™æ›´æ–°
  const obj = aircrafts.get(id);
  const prevData = obj.data;

  // é æ¸¬ç‹€æ…‹ (çˆ¬å‡/å·¡èˆª/é™è½)
  data.flightStatus = predictFlightStatus(data, prevData);
  
  // æª¢æŸ¥æ˜¯å¦æš«åœ (æ•¸å€¼å®Œå…¨æ²’è®Š)
  const isPaused = prevData && 
                   prevData.lat === data.lat && 
                   prevData.lon === data.lon && 
                   prevData.alt === data.alt;
                   
  obj.paused = isPaused;
  const el = obj.marker.getElement();
  if (el) el.style.opacity = isPaused ? "0.5" : "1";

  // æ›´æ–°å„²å­˜çš„è³‡æ–™
  obj.data = data;
  obj.lastSeen = now;

  // 3. è¨­å®šå¹³æ»‘å‹•ç•«ç›®æ¨™ (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†)
  if (!isNew && !isPaused) {
    // è¨ˆç®—å…©æ¬¡å°åŒ…çš„æ™‚é–“å·®ï¼Œä½œç‚ºé€™æ¬¡ç§»å‹•çš„å‹•ç•«æ™‚é–“
    // å¦‚æœæ™‚é–“å·®å¤ªä¹…(>5ç§’)æˆ–å¤ªçŸ­(<0.2ç§’)ï¼Œä½¿ç”¨é è¨­å€¼ 1000ms
    let duration = now - obj.lastPacketTs;
    if (duration > 5000 || duration < 200) duration = 1000; 
    
    // å–å¾—ç•¶å‰ Marker å¯¦éš›é¡¯ç¤ºçš„ä½ç½® (ä½œç‚ºå‹•ç•«èµ·é»)
    const currentLatLng = obj.marker.getLatLng();
    
    obj.anim = {
      startLat: currentLatLng.lat,
      startLon: currentLatLng.lng,
      endLat: data.lat,
      endLon: data.lon,
      startHeading: prevData.heading || 0,
      endHeading: data.heading || 0,
      startTime: now,
      duration: duration
    };
  }
  
  obj.lastPacketTs = now; // æ›´æ–°æ™‚é–“æˆ³è¨˜

  // 4. è¨˜éŒ„è»Œè·¡è³‡æ–™ (é‚è¼¯ä¸è®Š)
  if (!obj.paused && trackPoint) {
    if (!obj.rawTrack) obj.rawTrack = [];
    obj.rawTrack.push({lat: data.lat, lon: data.lon, ts: now, alt: data.alt, speed: data.speed});
    if (obj.rawTrack.length > 20000) obj.rawTrack.shift();
    
    if (!obj.rawPathForDisplay) obj.rawPathForDisplay = [];
    obj.rawPathForDisplay.push([data.lat, data.lon, data.alt, data.speed]);
  }

  // 5. æ›´æ–°æ¨™ç±¤æ–‡å­— (ä¸ç§»å‹•ä½ç½®ï¼Œåªæ›´æ–°æ–‡å­—èˆ‡é¡è‰²)
  if (el) {
    const label = el.querySelector('.label');
    if (label) {
      const color = getAltitudeColor(data.alt);
      const isEmergency = data.squawk === '7700';
      const squawkText = data.squawk ? `SQK:${escapeHtml(data.squawk)}` : '';
      const depShort = (data.departure||'').substring(0, 4);
      const arrShort = (data.arrival||'').substring(0, 4);
      
      label.className = isEmergency ? 'label emergency' : 'label';
      label.style.borderLeft = `3px solid ${color}`;
      label.innerHTML = `
        <strong>${escapeHtml(data.callsign||'UNK')}</strong>
        <div style="font-size:11px;">
          ${escapeHtml(data.type||'??')} Â· <span style="color:${color};font-weight:bold;">${Math.round(data.alt||0)}ft</span> Â· ${formatSpeed(data.speed)}kt
        </div>
        <div style="font-size:11px;">${escapeHtml(data.flightNo||'')} ${escapeHtml(depShort)}â†’${escapeHtml(arrShort)}</div>
        ${squawkText ? `<div style="font-size:11px;font-weight:bold;color:#ffff00;">${squawkText}</div>` : ''}
      `;
    }
  }

  // æ›´æ–°é€£ç·šæ•¸
  const connCountEl = document.getElementById('connCount');
  if(connCountEl) connCountEl.textContent = aircrafts.size;

  // å¦‚æœæ˜¯ç„¦é»é£›æ©Ÿï¼Œæ›´æ–°è»Œè·¡èˆ‡é¢æ¿
  if (id === focusedAircraftId) {
    // é€™è£¡æˆ‘å€‘ç¨å¾®ç¯€æµä¸€ä¸‹è»Œè·¡é‡ç¹ªï¼Œé¿å…å¤ªé »ç¹
    if (!obj.lastTrackUpdate || now - obj.lastTrackUpdate > 1000) {
        showAircraftTrack(id);
        obj.lastTrackUpdate = now;
    }
    showAircraftPanel(data, id);
    updateNextWaypointMarker(data); // æŠ½å‡ºæ›´æ–° Waypoint çš„é‚è¼¯
  }
}

// è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–° Next Waypoint Marker (å¾åŸ updateAircraft æŠ½å‡º)
function updateNextWaypointMarker(data) {
  if (nextWaypointMarker) {
    map.removeLayer(nextWaypointMarker);
    nextWaypointMarker = null;
  }
  if (data.nextWaypoint && data.flightPlan && Array.isArray(data.flightPlan)) {
    const nextWp = data.flightPlan.find(wp => (wp.ident || wp.name) === data.nextWaypoint);
    if (nextWp && !isNaN(Number(nextWp.lat)) && !isNaN(Number(nextWp.lon))) {
      const nextWpIcon = L.divIcon({
        html: `<img src="${NEXT_WAYPOINT_IMG}" class="next-waypoint-marker" style="width: 32px; height: 32px;">`,
        className: '', iconSize: [32, 32], iconAnchor: [16, 16]
      });
      nextWaypointMarker = L.marker([Number(nextWp.lat), Number(nextWp.lon)], { 
        icon: nextWpIcon, pane: 'waypointPane', zIndexOffset: 1000
      }).addTo(map);
      nextWaypointMarker.bindTooltip(`ğŸ¯ NEXT: ${data.nextWaypoint}`, {
        permanent: true, direction: 'top', className: 'waypoint-tooltip', offset: [0, -16]
      });
    }
  }
}
function removeAircraft(id) {
  if (aircrafts.has(id)) {
    const o = aircrafts.get(id);
    map.removeLayer(o.marker);
    o.segments.forEach(s => map.removeLayer(s));
    aircrafts.delete(id);
    document.getElementById('connCount').textContent = aircrafts.size;
  }
}
// è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ï¼ˆæµ·é‡Œï¼‰
function calculateFlightDistance(lat1, lon1, lat2, lon2) {
  const R = 3440.065; // åœ°çƒåŠå¾‘ï¼ˆæµ·é‡Œï¼‰
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// æ ¼å¼åŒ–æ™‚é–“ï¼ˆå°æ™‚:åˆ†é˜ï¼‰
function formatFlightDuration(ms) {
  if (!ms || ms < 0) return "00:00";
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

// è¨ˆç®—é£›è¡Œé€²åº¦
function calculateFlightProgress(data, airports) {
  let progress = 0;
  let totalDist = 0;
  let distFlown = 0;
  let distRem = 0;
  let elapsedTime = 0;
  let ete = 0;

  // æŸ¥æ‰¾èµ·é™æ©Ÿå ´
  const depAirport = airports.find(a => 
    a.ident === data.departure || 
    (data.departure && data.departure.length === 4 && a.ident.endsWith(data.departure))
  );
  const arrAirport = airports.find(a => 
    a.ident === data.arrival || 
    (data.arrival && data.arrival.length === 4 && a.ident.endsWith(data.arrival))
  );

  if (depAirport && arrAirport && data.lat && data.lon) {
    totalDist = calculateFlightDistance(
      depAirport.latitude_deg, 
      depAirport.longitude_deg, 
      arrAirport.latitude_deg, 
      arrAirport.longitude_deg
    );
    distFlown = calculateFlightDistance(
      depAirport.latitude_deg, 
      depAirport.longitude_deg, 
      data.lat, 
      data.lon
    );
    distRem = calculateFlightDistance(
      data.lat, 
      data.lon, 
      arrAirport.latitude_deg, 
      arrAirport.longitude_deg
    );
    
    if (totalDist > 0) {
      progress = Math.max(0, Math.min(100, (1 - (distRem / totalDist)) * 100));
    }
  }

  // æ™‚é–“è¨ˆç®—
  const now = Date.now();
  if (data.takeoffTime) {
    elapsedTime = now - new Date(data.takeoffTime).getTime();
  }
  
  if (distRem > 0 && data.speed > 10) {
    ete = (distRem / formatSpeed(data.speed)) * 3600 * 1000; // è½‰æ›ç‚ºæ¯«ç§’
  }

  return {
    progress,
    totalDist: Math.round(totalDist),
    distFlown: Math.round(distFlown),
    distRem: Math.round(distRem),
    elapsedTime,
    ete,
    depAirport,
    arrAirport
  };
}
// Panel
async function showAircraftPanel(data, id) {
  clearFlightPlanMarkers();
  
  // ğŸ”¥ åœ¨é€™è£¡æ·»åŠ ï¼šç¢ºä¿ flightStatus å­˜åœ¨
  if (!data.flightStatus) {
    const obj = aircrafts.get(id);
    const prev = obj && obj.data ? obj.data : null;
    data.flightStatus = predictFlightStatus(data, prev);
  }
  
  // ä¿å­˜å±•é–‹ç‹€æ…‹
  let wasExpanded = false;
  const oldPanel = document.getElementById('aircraftPanel');
  if (oldPanel) {
    const oldContent = oldPanel.querySelector('#expandedContent');
    wasExpanded = oldContent && oldContent.style.display === 'block';
  }
  
  // ç²å–èˆªç©ºå…¬å¸è³‡è¨Š - ğŸ”¥ ç§»åˆ°é€™è£¡
  const airlineInfo = getAirlineInfo(data.callsign, data.flightNo);
  const airlineName = airlineInfo ? airlineInfo.name : 'Unknown Airline';
  
  // è™•ç† flight plan
  let plan = data.flightPlan;
  if (typeof plan === 'string') {
    try {
      plan = JSON.parse(plan);
    } catch (err) {
      plan = null;
    }
  }
  
  // é¡¯ç¤º waypoints (ä¿ç•™ç¾æœ‰ä»£ç¢¼...)
  if (plan && Array.isArray(plan) && plan.length) {
    const latlngs = [];
    plan.forEach((wp, i) => {
      const lat = Number(wp.lat), lon = Number(wp.lon);
      if (isNaN(lat) || isNaN(lon)) return;
      const label = wp.ident || wp.name || ('WP' + (i + 1));
      const isNextWaypoint = data.nextWaypoint && 
                             (wp.ident === data.nextWaypoint || wp.name === data.nextWaypoint);
      
      const waypointIcon = L.divIcon({
        html: `<img src="${isNextWaypoint ? NEXT_WAYPOINT_IMG : 'https://i.ibb.co/VWH3qBpX/2.png'}" 
                    class="${isNextWaypoint ? 'next-waypoint-marker' : ''}" 
                    style="width: ${isNextWaypoint ? 32 : 24}px; height: ${isNextWaypoint ? 32 : 24}px;">`,
        className: '',
        iconSize: [isNextWaypoint ? 32 : 24, isNextWaypoint ? 32 : 24],
        iconAnchor: [isNextWaypoint ? 16 : 12, isNextWaypoint ? 16 : 12]
      });
      
      const m = L.marker([lat, lon], {
        icon: waypointIcon,
        pane: 'waypointPane'
      }).addTo(map).bindTooltip(isNextWaypoint ? `NEXT: ${label}` : label, {
        permanent: isNextWaypoint,
        direction: 'top',
        className: 'waypoint-tooltip',
        offset: [0, -12]
      });
      flightPlanMarkers.push(m);
      latlngs.push([lat, lon]);
    });
    
    if (latlngs.length > 1) {
      const route = L.polyline(latlngs, {
        color: '#CEA5D5',
        weight: 4,
        opacity: 1,
        dashArray: '8 8',
        pane: 'waypointPane'
      }).addTo(map);
      flightPlanMarkers.push(route);
    }
  }

  // è¼‰å…¥ç”¨æˆ¶ç…§ç‰‡
  let userPhotos = [];
  if (data.userId) {
    try {
      console.log('ğŸ“¸ Fetching photos for userId:', data.userId);
      const response = await fetch(`/api/photos/user/${data.userId}`);
      userPhotos = await response.json();
      console.log('ğŸ“¸ Found photos:', userPhotos.length);
    } catch (err) {
      console.error('Failed to load user photos:', err);
    }
  } 
  // å»ºç«‹æˆ–æ›´æ–° Panel

  let p = document.getElementById('aircraftPanel');
  if (!p) {
    p = document.createElement('div');
    p.id = 'aircraftPanel';
    Object.assign(p.style, {
      position: 'absolute',
      top: '10px',
      right: '10px',
      width: '420px',
      background: '#f5f5f5',
      borderRadius: '8px',
      boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
      fontSize: '13px',
      zIndex: 9999,
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      overflow: 'hidden',
      maxHeight: '90vh',
      overflowY: 'auto'
    });
    document.body.appendChild(p);
  }

  const depShort = (data.departure || '').substring(0, 4) || 'â€”';
  const arrShort = (data.arrival || '').substring(0, 4) || 'â€”';
  const isEmergency = data.squawk === '7700';

// ç…§ç‰‡è¼ªæ’­ HTML
  let photosHtml = '';
  if (userPhotos.length > 0) {
    photosHtml = `
      <div id="photoContainer" style="position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden;">
        <img id="panelPhoto" src="${userPhotos[0].thumb}" style="width:100%;height:100%;object-fit:cover;">
        
        ${userPhotos.length > 1 ? `
          <!-- å·¦ç®­é ­ -->
          <button id="photoPrev" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);
                  background:rgba(0,0,0,0.6);color:#fff;border:none;width:40px;height:40px;
                  border-radius:50%;cursor:pointer;font-size:20px;display:none;
                  transition:background 0.3s;z-index:10;">
            â€¹
          </button>
          
          <!-- å³ç®­é ­ -->
          <button id="photoNext" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);
                  background:rgba(0,0,0,0.6);color:#fff;border:none;width:40px;height:40px;
                  border-radius:50%;cursor:pointer;font-size:20px;display:none;
                  transition:background 0.3s;z-index:10;">
            â€º
          </button>
        ` : ''}
        
        <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:#fff;
                    padding:4px 8px;border-radius:4px;font-size:11px;z-index:5;">
          Â© <span id="photoCredit">${escapeHtml(userPhotos[0].photographer || 'Anonymous')}</span>
        </div>
        
        ${userPhotos.length > 1 ? `
          <div style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:5;">
            ${userPhotos.map((_, i) => `
              <button class="photo-dot" data-index="${i}" style="width:8px;height:8px;border-radius:50%;border:none;
                      background:${i === 0 ? '#ffd500' : 'rgba(255,255,255,0.5)'};cursor:pointer;padding:0;"></button>
            `).join('')}
          </div>
        ` : ''}
      </div>
        <!-- é£›è¡Œç‹€æ…‹åœ–ç‰‡ -->
<div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
  <img src="${data.flightStatus?.image || FLIGHT_STATUS_IMAGES.cruise}" 
       alt="${data.flightStatus?.text || 'In Flight'}" 
       style="width:64px;height:64px;object-fit:contain;">
  <div style="font-size:12px;font-weight:600;color:${data.flightStatus?.color || '#2196F3'};">
    ${data.flightStatus?.text || 'In Flight'}
  </div>
</div>
        <div style="text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#000;line-height:1;">${escapeHtml(arrShort)}</div>
          <div style="font-size:13px;color:#666;margin-top:4px;">${escapeHtml(data.arrival || 'â€”')}</div>
          <div style="font-size:11px;color:#999;margin-top:2px;">UTC +00:00</div>
        </div>
      </div>

      ${(() => {
        const flightProgress = calculateFlightProgress(data, airportsData);
        if (flightProgress.depAirport && flightProgress.arrAirport) {
          return `
            <!-- Flightradar24 Style Progress Bar -->
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="text-align:left;">
                  <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:2px;">ELAPSED</div>
                  <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${formatFlightDuration(flightProgress.elapsedTime)}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:2px;">REMAINING</div>
                  <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${flightProgress.ete > 0 ? formatFlightDuration(flightProgress.ete) : '--:--'}</div>
                </div>
              </div>
              
              <!-- Progress Bar -->
              <div style="position:relative;width:100%;height:4px;background:#e0e0e0;border-radius:2px;margin:12px 0;overflow:visible;">
                <div style="position:absolute;left:0;top:0;width:${flightProgress.progress}%;height:100%;background:#ffd500;border-radius:2px;transition:width 0.5s linear;"></div>
                <!-- Plane Icon -->
                <div style="position:absolute;left:${flightProgress.progress}%;top:50%;transform:translate(-50%, -50%) rotate(90deg);transition:left 0.5s linear;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#000" style="filter:drop-shadow(0 0 2px rgba(255,213,0,0.8));">
                    <path d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                  </svg>
                </div>
              </div>
              
              <div style="display:flex;justify-content:space-between;font-size:12px;color:#666;">
                <span style="font-weight:600;">${flightProgress.distFlown} <span style="font-weight:400;color:#999;">nm</span></span>
                <span style="font-weight:600;">${flightProgress.distRem} <span style="font-weight:400;color:#999;">nm</span></span>
              </div>
            </div>
          `;
        } else if (data.takeoffTime) {
          return `
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
              <div>
                <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">TAKEOFF TIME</div>
                <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${escapeHtml(data.takeoffTime.substring(11, 19))} UTC</div>
              </div>
            </div>
          `;
        }
        return '';
      })()}
    </div>
    `;
  } else {
    // é è¨­é£›æ©Ÿåœ–ï¼ˆå¦‚æœæ²’æœ‰ç”¨æˆ¶ç…§ç‰‡ï¼‰
    photosHtml = `
      <div style="position:relative;width:100%;aspect-ratio:16/9;background:#000;">
        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#666;font-size:48px;">
          âœˆï¸
        </div>
      </div>
    `;
  }

  p.innerHTML = `
    <!-- Top Header -->
    <div style="background:#1a1a1a;padding:16px;display:flex;justify-content:space-between;align-items:center;position:relative;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:24px;font-weight:700;color:#ffd500;">${escapeHtml(data.callsign || 'UNKNOWN')}</span>
        <span style="background:#444;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">
          ${escapeHtml(data.flightNo || 'N/A')}
        </span>
        <span style="background:#0066cc;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">
          ${escapeHtml(data.type || '??')}
        </span>
      </div>
      
      <div style="display:flex;gap:8px;align-items:center;">
        <button style="background:transparent;border:none;color:#ffd500;cursor:pointer;padding:4px;font-size:20px;">â˜…</button>
        <button onclick="document.getElementById('aircraftPanel').remove();clearAllAircraftTracks();focusedAircraftId=null;clearFlightPlanMarkers();" 
        style="background:transparent;border:none;color:#fff;cursor:pointer;padding:4px;font-size:20px;">Ã—</button>
      </div>
      
      <div style="position:absolute;top:8px;right:60px;font-size:10px;color:#ffd500;font-weight:700;letter-spacing:0.5px;">
        flightradar<span style="color:#fff;">24</span>
      </div>
    </div>

    <div style="font-size:13px;color:#fff;background:#1a1a1a;padding-bottom:12px;padding-left:16px;">
      ${escapeHtml(airlineName)}
    </div>

    ${isEmergency ? '<div style="background:#d32f2f;color:#fff;padding:12px;text-align:center;font-weight:600;font-size:14px;">âš ï¸ EMERGENCY SQUAWK 7700</div>' : ''}

    <!-- Hero Image -->
    ${photosHtml}

    <!-- Route Block -->
    <div style="background:#fff;padding:24px 16px;border-bottom:1px solid #e0e0e0;">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;margin-bottom:16px;">
        <div style="text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#000;line-height:1;">${escapeHtml(depShort)}</div>
          <div style="font-size:13px;color:#666;margin-top:4px;">${escapeHtml(data.departure || 'â€”')}</div>
          <div style="font-size:11px;color:#999;margin-top:2px;">UTC +04:00</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
          <img src="${data.flightStatus?.image || FLIGHT_STATUS_IMAGES.cruise}" 
               alt="${data.flightStatus?.text || 'In Flight'}" 
               style="width:64px;height:64px;object-fit:contain;">
          <div style="font-size:12px;font-weight:600;color:${data.flightStatus?.color || '#2196F3'};">
            ${data.flightStatus?.text || 'In Flight'}
          </div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#000;line-height:1;">${escapeHtml(arrShort)}</div>
          <div style="font-size:13px;color:#666;margin-top:4px;">${escapeHtml(data.arrival || 'â€”')}</div>
          <div style="font-size:11px;color:#999;margin-top:2px;">UTC +00:00</div>
        </div>
      </div>

      ${(() => {
        const flightProgress = calculateFlightProgress(data, airportsData);
        if (flightProgress.depAirport && flightProgress.arrAirport && data.takeoffTime) {
          return `
            <!-- Flightradar24 Style Progress Bar -->
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="text-align:left;">
                  <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:2px;">ELAPSED</div>
                  <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${formatFlightDuration(flightProgress.elapsedTime)}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:2px;">REMAINING</div>
                  <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${flightProgress.ete > 0 ? formatFlightDuration(flightProgress.ete) : '--:--'}</div>
                </div>
              </div>
              
              <!-- Progress Bar -->
              <div style="position:relative;width:100%;height:4px;background:#e0e0e0;border-radius:2px;margin:12px 0;overflow:visible;">
                <div style="position:absolute;left:0;top:0;width:${flightProgress.progress}%;height:100%;background:#ffd500;border-radius:2px;transition:width 0.5s linear;"></div>
                <!-- Plane Icon -->
                <div style="position:absolute;left:${flightProgress.progress}%;top:50%;transform:translate(-50%, -50%) rotate(90deg);transition:left 0.5s linear;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#000" style="filter:drop-shadow(0 0 2px rgba(255,213,0,0.8));">
                    <path d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                  </svg>
                </div>
              </div>
              
              <div style="display:flex;justify-content:space-between;font-size:12px;color:#666;">
                <span style="font-weight:600;">${flightProgress.distFlown} <span style="font-weight:400;color:#999;">nm</span></span>
                <span style="font-weight:600;">${flightProgress.distRem} <span style="font-weight:400;color:#999;">nm</span></span>
              </div>
            </div>
          `;
        } else if (data.takeoffTime) {
          return `
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
              <div>
                <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">TAKEOFF TIME</div>
                <div style="font-size:16px;font-weight:700;color:#000;font-family:monospace;">${escapeHtml(data.takeoffTime.substring(11, 19))} UTC</div>
              </div>
            </div>
          `;
        }
        return '';
      })()}
    </div>

    <!-- Expandable Toggle -->
    <button id="expandBtn" style="width:100%;background:#fff;border:none;border-bottom:1px solid #e0e0e0;
            padding:12px 16px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;
            color:#0066cc;font-size:13px;font-weight:600;">
      <span style="font-size:20px;">âœˆ</span>
      More ${escapeHtml(data.flightNo || data.callsign)} information
      <span id="expandIcon">â–¼</span>
    </button>

    <!-- Expanded Content -->
    <div id="expandedContent" style="display:none;background:#fff;padding:20px 16px;">
      <div style="margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;color:#666;font-size:12px;
                    text-transform:uppercase;font-weight:600;">
          <span style="font-size:16px;">âœˆ</span>
          AIRCRAFT TYPE (${escapeHtml(data.type || '??')})
        </div>
        <div style="font-size:18px;font-weight:600;color:#000;">
          ${escapeHtml(data.type || 'Unknown Aircraft')}
        </div>
      </div>

      ${data.userId ? `
        <div style="margin-bottom:24px;">
          <div style="font-size:12px;color:#666;text-transform:uppercase;font-weight:600;margin-bottom:8px;">
            user ID
          </div>
          <div style="font-size:16px;color:#000;">${escapeHtml(data.userId)}</div>
        </div>
      ` : ''}

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">ALTITUDE</div>
          <div style="font-size:18px;font-weight:600;color:#000;">${Math.round(data.alt || 0).toLocaleString()} ft</div>
        </div>
        <div>
          <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">SPEED</div>
          <div style="font-size:18px;font-weight:600;color:#000;">${formatSpeed(data.speed)} kt</div>
        </div>
        <div>
          <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">HEADING</div>
          <div style="font-size:18px;font-weight:600;color:#000;">${Math.round(data.heading || 0)}Â°</div>
        </div>
        <div>
          <div style="font-size:11px;color:#999;text-transform:uppercase;margin-bottom:4px;">SQUAWK</div>
          <div style="font-size:18px;font-weight:600;color:${isEmergency ? '#ff4444' : '#000'};">
            ${escapeHtml(data.squawk || 'â€”')}
          </div>
        </div>
      </div>
    </div>
  `;

// ç…§ç‰‡è¼ªæ’­åŠŸèƒ½ - å®Œæ•´ç‰ˆ
  if (userPhotos.length > 1) {
    const container = p.querySelector('#photoContainer');
    const dots = p.querySelectorAll('.photo-dot');
    const photoImg = p.querySelector('#panelPhoto');
    const photoCredit = p.querySelector('#photoCredit');
    const prevBtn = p.querySelector('#photoPrev');
    const nextBtn = p.querySelector('#photoNext');
    
    // ä¿å­˜ç•¶å‰ç…§ç‰‡ç´¢å¼•
    if (!window.aircraftPhotoIndex) window.aircraftPhotoIndex = {};
    if (!window.aircraftPhotoIndex[id]) window.aircraftPhotoIndex[id] = 0;
    
    let currentIndex = window.aircraftPhotoIndex[id];
    
    // æ›´æ–°ç…§ç‰‡é¡¯ç¤º
    function updatePhoto(index) {
      photoImg.src = userPhotos[index].thumb;
      photoCredit.textContent = escapeHtml(userPhotos[index].photographer || 'Anonymous');
      dots.forEach((d, i) => {
        d.style.background = i === index ? '#ffd500' : 'rgba(255,255,255,0.5)';
      });
      window.aircraftPhotoIndex[id] = index;
    }
    
    // æ¢å¾©ä¸Šæ¬¡çš„ç…§ç‰‡
    updatePhoto(currentIndex);
    
    // æ»‘é¼ æ‡¸åœé¡¯ç¤ºç®­é ­
    container.addEventListener('mouseenter', () => {
      if (prevBtn) prevBtn.style.display = 'block';
      if (nextBtn) nextBtn.style.display = 'block';
    });
    
    container.addEventListener('mouseleave', () => {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
    });
    
    // ç®­é ­ hover æ•ˆæœ
    if (prevBtn) {
      prevBtn.addEventListener('mouseenter', () => prevBtn.style.background = 'rgba(0,0,0,0.9)');
      prevBtn.addEventListener('mouseleave', () => prevBtn.style.background = 'rgba(0,0,0,0.6)');
    }
    if (nextBtn) {
      nextBtn.addEventListener('mouseenter', () => nextBtn.style.background = 'rgba(0,0,0,0.9)');
      nextBtn.addEventListener('mouseleave', () => nextBtn.style.background = 'rgba(0,0,0,0.6)');
    }
    
    // åˆ‡æ›åˆ°ä¸Šä¸€å¼µ
    if (prevBtn) {
      prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex - 1 + userPhotos.length) % userPhotos.length;
        updatePhoto(currentIndex);
        restartAutoSlide();
      });
    }
    
    // åˆ‡æ›åˆ°ä¸‹ä¸€å¼µ
    if (nextBtn) {
      nextBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % userPhotos.length;
        updatePhoto(currentIndex);
        restartAutoSlide();
      });
    }
    
    // é»æ“Šåœ“é»åˆ‡æ›
    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.getAttribute('data-index'));
        currentIndex = index;
        updatePhoto(index);
        restartAutoSlide();
      });
    });
    
    // é‡å•Ÿè‡ªå‹•è¼ªæ’­
    function restartAutoSlide() {
      if (window.aircraftPhotoTimer && window.aircraftPhotoTimer[id]) {
        clearInterval(window.aircraftPhotoTimer[id]);
      }
      startAutoSlide();
    }
    
    // è‡ªå‹•è¼ªæ’­ (æ¯5ç§’)
    function startAutoSlide() {
      if (!window.aircraftPhotoTimer) window.aircraftPhotoTimer = {};
      if (window.aircraftPhotoTimer[id]) clearInterval(window.aircraftPhotoTimer[id]);
      
      window.aircraftPhotoTimer[id] = setInterval(() => {
        currentIndex = (currentIndex + 1) % userPhotos.length;
        updatePhoto(currentIndex);
      }, 5000);
    }
    
    startAutoSlide();
  }

  // å±•é–‹/æ”¶åˆåŠŸèƒ½
  const expandBtn = p.querySelector('#expandBtn');
  const expandedContent = p.querySelector('#expandedContent');
  const expandIcon = p.querySelector('#expandIcon');
  
  // æ¢å¾©ä¹‹å‰çš„å±•é–‹ç‹€æ…‹
  if (wasExpanded) {
    expandedContent.style.display = 'block';
    expandIcon.textContent = 'â–²';
  }
  
  expandBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isExpanded = expandedContent.style.display === 'block';
    if (isExpanded) {
      expandedContent.style.display = 'none';
      expandIcon.textContent = 'â–¼';
    } else {
      expandedContent.style.display = 'block';
      expandIcon.textContent = 'â–²';
    }
  });
}

// Photo Map åŠŸèƒ½
let photoMapEnabled = false;
let photoMarkers = [];

const planeIcon = L.divIcon({
  html: '<div style="font-size: 24px;">âœˆï¸</div>',
  className: 'plane-marker',
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

function togglePhotoMap() {
  const btn = document.getElementById('photoMapToggle');
  photoMapEnabled = !photoMapEnabled;
  
  if (photoMapEnabled) {
    btn.classList.add('active');
    btn.textContent = 'ğŸ“ Hide Photos';
    loadPhotoMarkers();
  } else {
    btn.classList.remove('active');
    btn.textContent = 'ğŸ“ Photo Map';
    clearPhotoMarkers();
  }
}

function clearPhotoMarkers() {
  photoMarkers.forEach(marker => map.removeLayer(marker));
  photoMarkers = [];
}

async function loadPhotoMarkers() {
  try {
    const response = await fetch('/api/photos');
    const photos = await response.json();
    
    const photosWithLocation = photos.filter(photo => 
      photo.lat !== null && photo.lon !== null
    );
    
    photosWithLocation.forEach(photo => {
      const marker = L.marker([photo.lat, photo.lon], {
        icon: planeIcon,
        zIndexOffset: -1000 // ç¢ºä¿ç…§ç‰‡æ¨™è¨˜åœ¨é£›æ©Ÿæ¨™è¨˜ä¸‹æ–¹
      }).addTo(map);
      
      const popupContent = `
        <div class="photo-popup">
          <img src="${photo.thumb}" alt="${escapeHtml(photo.caption)}" onclick="window.open('${photo.file}', '_blank')">
          <h3>${escapeHtml(photo.caption)}</h3>
          <div class="info">ğŸ“· ${escapeHtml(photo.photographer)}</div>
          <div class="info">ğŸ“… ${new Date(photo.createdAt).toLocaleDateString('en-US')}</div>
          ${photo.tags && photo.tags.length > 0 ? `
            <div class="tags">
              ${photo.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      marker.bindPopup(popupContent, {
        maxWidth: 320
      });
      
      photoMarkers.push(marker);
    });
  // Debug: æª¢æŸ¥ userId
  console.log('ğŸ” Aircraft data userId:', data.userId);
    console.log(`Loaded ${photoMarkers.length} photo markers`);
  } catch (error) {
    console.error('Failed to load photo markers:', error);
  }
}
// WebSocket
let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', () => ws.send(JSON.stringify({type: 'hello', role: 'atc'})));
  ws.addEventListener('message', ev => {
    try {
      const m = JSON.parse(ev.data);
      if (m.type === 'aircraft_update') {
        (Array.isArray(m.payload) ? m.payload : [m.payload]).forEach(a => 
          updateAircraft(a.id, a, m.trackPoint)
        );
      }
      else if (m.type === 'aircraft_snapshot') {
        m.payload.forEach(a => updateAircraft(a.id, a));
        // è¼‰å…¥æ‰€æœ‰é£›æ©Ÿçš„æ­·å²è»Œè·¡
        setTimeout(() => {
          loadAllHistoryFromBackend();
          console.log('ğŸ“¡ Loading history from backend...');
        }, 1000);
      }
      // è™•ç†æ‰¹æ¬¡æ›´æ–°
else if (m.type === 'aircraft_batch_update') {
  m.payload.forEach(a => updateAircraft(a.id, a));
}
else if (m.type === 'aircraft_track_history') {
        const { aircraftId, tracks } = m.payload;
        if (!tracks || tracks.length === 0) return;
        
        if (!aircrafts.has(aircraftId)) {
          const lastTrack = tracks[tracks.length - 1];
          const dummyData = {
            callsign: aircraftId,
            type: '??',
            lat: lastTrack.lat,
            lon: lastTrack.lon,
            alt: lastTrack.alt,
            heading: 0,
            speed: lastTrack.speed || 0,
            squawk: ''
          };
          const marker = L.marker([lastTrack.lat, lastTrack.lon], { icon: makeDivIcon(dummyData) }).addTo(map);
          marker.on('click', () => {
            clearAllAircraftTracks();
            focusedAircraftId = aircraftId;
            showAircraftTrack(aircraftId);
            showAircraftPanel(dummyData, aircraftId);
          });
          aircrafts.set(aircraftId, {
            marker,
            path: [],
            rawTrack: [],
            rawPathForDisplay: [],
            displayPath: [],
            segments: [],
            lastSeen: Date.now(),
            data: dummyData
          });
        }
        
        const obj = aircrafts.get(aircraftId);
        if (!obj.rawPathForDisplay) obj.rawPathForDisplay = [];
        if (!obj.rawTrack) obj.rawTrack = [];
        
        // æ¸…é™¤èˆŠè³‡æ–™ä»¥é¿å…é‡è¤‡
        obj.rawPathForDisplay = [];
        obj.rawTrack = [];
        
        // æ·»åŠ  history è³‡æ–™
        tracks.forEach(t => {
          obj.rawPathForDisplay.push([t.lat, t.lon, t.alt || 0, t.speed || 0]);
          obj.rawTrack.push({
            lat: t.lat,
            lon: t.lon,
            alt: t.alt || 0,
            speed: t.speed || 0,
            ts: t.ts || Date.now()
          });
        });
        
        // å¦‚æœé€™æ¶é£›æ©Ÿæ­£åœ¨è¢« focus,ç«‹å³æ›´æ–°è»Œè·¡
        if (focusedAircraftId === aircraftId) {
          showAircraftTrack(aircraftId);
        }
      }

      else if (m.type === 'aircraft_track_clear') {
        const { aircraftId } = m.payload;
        if (aircrafts.has(aircraftId)) {
          aircrafts.get(aircraftId).segments.forEach(s => map.removeLayer(s));
          aircrafts.get(aircraftId).segments = [];
        }
      }
      else if (m.type === 'aircraft_remove') {
        m.payload.forEach(id => removeAircraft(id));
      }
    } catch (e) {
      console.warn('Message parse error:', e);
    }
  });
  ws.addEventListener('close', () => setTimeout(connectWS, 2000));
  ws.addEventListener('error', () => ws.close());
}
// è¼‰å…¥æ©Ÿå ´æ•¸æ“š
let airportsData = [];
async function loadAirports() {
  try {
    const response = await fetch('https://raw.githubusercontent.com/mwgg/Airports/refs/heads/master/airports.json');
    if (!response.ok) throw new Error('Failed to fetch airports');
    const airports = await response.json();
    
    airportsData = Object.entries(airports).map(([icao, data]) => ({
      ident: icao,
      name: data.name,
      latitude_deg: data.lat,
      longitude_deg: data.lon,
      municipality: data.city,
      iso_country: data.country,
      iata: data.iata
    }));
    
    console.log('âœ… Loaded', airportsData.length, 'airports');
  } catch (error) {
    console.error('Failed to load airports:', error);
  }
}

// åœ¨é é¢è¼‰å…¥æ™‚è¼‰å…¥æ©Ÿå ´æ•¸æ“š
loadAirports();

// åœ¨é é¢è¼‰å…¥æ™‚è¼‰å…¥æ©Ÿå ´æ•¸æ“š
loadAirports();
connectWS();

// ========== å¹³æ»‘ç§»å‹•å‹•ç•«ç³»çµ± ==========

// è¨ˆç®—æœ€çŸ­æ—‹è½‰è§’åº¦ (è™•ç† 359Â° -> 1Â° çš„éæ¸¡)
function getShortestAngleDiff(start, end) {
  let diff = (end - start + 180) % 360 - 180;
  return diff < -180 ? diff + 360 : diff;
}

// å‹•ç•«è¿´åœˆ
function animateAircrafts() {
  const now = Date.now();
  
  aircrafts.forEach((obj, id) => {
    // å¦‚æœæ²’æœ‰å‹•ç•«ç›®æ¨™ï¼Œæˆ–å·²ç¶“æš«åœï¼Œå°±è·³é
    if (!obj.anim || obj.paused) return;
    
    const elapsed = now - obj.anim.startTime;
    let progress = elapsed / obj.anim.duration;
    
    // é™åˆ¶é€²åº¦åœ¨ 0 åˆ° 1 ä¹‹é–“ (å¦‚æœç¶²è·¯å»¶é²ï¼Œé£›æ©Ÿæœƒåœåœ¨ç›®æ¨™é»ç­‰å¾…)
    if (progress > 1) progress = 1;
    
    // è¨ˆç®—ç•¶å‰ä½ç½® (ç·šæ€§æ’å€¼)
    const currentLat = obj.anim.startLat + (obj.anim.endLat - obj.anim.startLat) * progress;
    const currentLon = obj.anim.startLon + (obj.anim.endLon - obj.anim.startLon) * progress;
    
    // è¨ˆç®—ç•¶å‰èˆªå‘ (å¹³æ»‘æ—‹è½‰)
    const headingDiff = getShortestAngleDiff(obj.anim.startHeading, obj.anim.endHeading);
    const currentHeading = obj.anim.startHeading + (headingDiff * progress);
    
    // æ›´æ–° Leaflet Marker ä½ç½®
    obj.marker.setLatLng([currentLat, currentLon]);
    
    // æ›´æ–°é£›æ©Ÿåœ–ç¤ºæ—‹è½‰
    const el = obj.marker.getElement();
    if (el) {
      const img = el.querySelector('img');
      if (img) {
        img.style.transform = `rotate(${currentHeading}deg)`;
      }
    }
  });
  
  requestAnimationFrame(animateAircrafts);
}

// å•Ÿå‹•å‹•ç•«è¿´åœˆ
requestAnimationFrame(animateAircrafts);

function updateUTCTime() {
  const now = new Date();
  const utc = now.toISOString().replace('T', ' ').slice(0, 19);
  const el = document.getElementById('utcTimeText');
  if (el) el.textContent = utc;
}

function getTimeInTimeZone(tz) {
  try {
    const timeStr = new Date().toLocaleTimeString("en-US", {
      hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit", timeZone: tz
    });
    const [h, m, s] = timeStr.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m, s, 0);
    return d;
  } catch (e) {
    return new Date();
  }
}

function rotateClock(svg, now) {
  const hour = svg.querySelector("line[id$='-hour']");
  const minute = svg.querySelector("line[id$='-minute']");
  if (!hour || !minute) return;
  const h = now.getHours() % 12, m = now.getMinutes();
  hour.setAttribute("transform", `rotate(${h * 30 + m * 0.5} 20 20)`);
  minute.setAttribute("transform", `rotate(${m * 6} 20 20)`);
}

function createClockSVG(id, label, timeZone) {
  const container = document.createElement("div");
  container.style.textAlign = "center";
  container.style.fontSize = "10px";
  container.innerHTML = `<div style="margin-bottom: 4px; font-weight: bold;">${label}</div>`;
  
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "40");
  svg.setAttribute("height", "40");
  svg.setAttribute("viewBox", "0 0 40 40");
  
  let hourNow = 12;
  try {
    const tStr = new Date().toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", timeZone });
    hourNow = parseInt(tStr, 10);
  } catch {}
  
  const isDay = hourNow >= 6 && hourNow < 18;
  const clockFaceURL = isDay
    ? "https://clock-day.short.gy/0Fxzwe"
    : "https://clock-day.short.gy/2ZpDoNight";
  const pointerColor = isDay ? "black" : "white";

  svg.innerHTML = `
    <defs>
      <clipPath id="clockClip-${id}">
        <circle cx="20" cy="20" r="18"/>
      </clipPath>
      <g id="clockHands-${id}">
        <line id="${id}-hour" x1="20" y1="20" x2="20" y2="11" stroke="${pointerColor}" stroke-width="2"/>
        <line id="${id}-minute" x1="20" y1="20" x2="20" y2="7" stroke="${pointerColor}" stroke-width="1"/>
      </g>
    </defs>
    <image href="${clockFaceURL}" x="0" y="0" width="40" height="40" clip-path="url(#clockClip-${id})"/>
    <use href="#clockHands-${id}"/>
  `;
  
  container.appendChild(svg);
  return container;
}

function initializeClocks() {
  const clockContainer = document.getElementById('clockContainer');
  if (!clockContainer) return;
  
  const utcClock = createClockSVG("utc", "UTC", "UTC");
  clockContainer.appendChild(utcClock);
  rotateClock(utcClock, getTimeInTimeZone("UTC"));
  
  const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const localClock = createClockSVG("local", "Local", localTz);
  clockContainer.appendChild(localClock);
  rotateClock(localClock, getTimeInTimeZone(localTz));
  
  setInterval(() => {
    rotateClock(utcClock, getTimeInTimeZone("UTC"));
    rotateClock(localClock, getTimeInTimeZone(localTz));
  }, 1000);
}

setInterval(updateUTCTime, 1000);
updateUTCTime();
initializeClocks();
// ========== METAR System Integration ==========
const ICON_MAP = {
  "cloud-ovc": "https://i.ibb.co/KnY57pG/cloud-ovc.png",
  "cloud-bkn": "https://i.ibb.co/Tx4r0N48/cloud-bkn.png",
  "cloud-sct": "https://i.ibb.co/S4znY40y/cloud-sct.png",
  "cloud-few": "https://i.ibb.co/VYfNTq34/cloud-few.png",
  "visibility": "https://i.ibb.co/3mPWNyw7/visibility.png",
  "pressure": "https://i.ibb.co/1tMJ2svB/pressure.png",
  "temperature": "https://i.ibb.co/N0TX606/temperature.png",
  "fog": "https://i.ibb.co/B2605gZ8/fog.png",
  "wind": "https://i.ibb.co/rfFL0X8v/wind.png"
};

function isValidMetarResponse(text) {
  if (!text || !text.trim()) return false;
  try {
    const parsed = JSON.parse(text);
    if (parsed.type === "FeatureCollection" && parsed.features && Array.isArray(parsed.features) && parsed.features.length === 0) {
      return false;
    }
  } catch (e) {}
  return true;
}

async function fetchMETAR(icao) {
  try {
    const vatsimRes = await fetch(`https://weather.geo-fs.com/?icao=${icao}`);
    if (vatsimRes.ok) {
      const text = await vatsimRes.text();
      if (isValidMetarResponse(text)) {
        return text.trim();
      }
    }
  } catch (e) {
    console.warn("VATSIM METAR fetch failed, trying AVWX:", e);
  }
  try {
    const avwxRes = await fetch(`https://geofs-metar-cors-8pch.onrender.com/metar?icao=${icao}`);
    if (avwxRes.ok) {
      const json = await avwxRes.json();
      if (json && json.raw && json.raw.trim()) {
        return json.raw.trim();
      }
    }
  } catch (e) {
    console.error("AVWX METAR fetch failed:", e);
  }
  return null;
}

function showMetarWidget(metar, icao) {
  let widget = document.getElementById('metarWidget');
  let toggleBtn = document.getElementById('metarToggle');
  
  // å‰µå»º Toggle Button
  if (!toggleBtn) {
    toggleBtn = document.createElement('button');
    toggleBtn.id = 'metarToggle';
    toggleBtn.innerHTML = 'ğŸŒ¤ï¸ METAR';
    toggleBtn.onclick = function() {
      widget.classList.toggle('open');
    };
    document.body.appendChild(toggleBtn);
  }
  
  // å‰µå»º Widget
  if (!widget) {
    widget = document.createElement('div');
    widget.id = 'metarWidget';
    widget.className = 'metar-widget';
    document.body.appendChild(widget);
  }

  const title = document.createElement("div");
  title.style.cssText = "font-weight:bold;margin-bottom:8px;font-size:13px;";
  title.textContent = `METAR @ ${icao}`;

  const searchDiv = document.createElement("div");
  searchDiv.style.cssText = "margin:6px 0 8px 0;display:flex;gap:4px;";
  
  const searchInput = document.createElement("input");
  searchInput.type = "text";
  searchInput.placeholder = "Enter ICAO manually";
  searchInput.style.cssText = 'font-size:11px;padding:4px 6px;flex:1;border-radius:4px;border:1px solid #555;background:#1a1a1a;color:white;';
  searchInput.maxLength = 4;
  searchInput.value = icao;
  searchInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
  });
  searchInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      manualSearch();
      e.preventDefault();
    }
  });

  const searchBtn = document.createElement("button");
  searchBtn.textContent = "Search";
  searchBtn.style.cssText = "font-size:11px;padding:4px 10px;cursor:pointer;background:#333;color:white;border:1px solid #555;border-radius:4px;";
  searchBtn.onclick = manualSearch;

  async function manualSearch() {
    const inputVal = searchInput.value.trim().toUpperCase();
    if (!inputVal || inputVal.length !== 4) {
      alert("Please enter a valid 4-letter ICAO code");
      return;
    }
    const metar = await fetchMETAR(inputVal);
    if (metar) {
      showMetarWidget(metar, inputVal);
    } else {
      alert(`No METAR available for ${inputVal}`);
    }
  }

  searchDiv.appendChild(searchInput);
  searchDiv.appendChild(searchBtn);

  // å‰µå»ºæ™‚é˜å®¹å™¨
  const clockContainer = document.createElement("div");
  clockContainer.style.cssText = "display:flex;justify-content:space-around;margin:8px 0;padding:8px 0;border-top:1px solid #333;border-bottom:1px solid #333;";
  
  function createClock(label, timeZone) {
    const container = document.createElement("div");
    container.style.cssText = "text-align:center;";
    
    const labelDiv = document.createElement("div");
    labelDiv.textContent = label;
    labelDiv.style.cssText = "font-size:10px;margin-bottom:4px;color:#aaa;";
    
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", "50");
    svg.setAttribute("height", "50");
    svg.setAttribute("viewBox", "0 0 40 40");
    
    let hourNow = 12;
    try {
      const tStr = new Date().toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", timeZone });
      hourNow = parseInt(tStr, 10);
    } catch {}
    
    const isDay = hourNow >= 6 && hourNow < 18;
    const clockFaceURL = isDay ? "https://clock-day.short.gy/0Fxzwe" : "https://clock-day.short.gy/2ZpDoNight";
    const pointerColor = isDay ? "black" : "white";
    
    const uniqueId = `clock-${label}-${Date.now()}`;
    svg.innerHTML = `
      <defs>
        <clipPath id="clockClip-${uniqueId}">
          <circle cx="20" cy="20" r="18"/>
        </clipPath>
      </defs>
      <image href="${clockFaceURL}" x="0" y="0" width="40" height="40" clip-path="url(#clockClip-${uniqueId})"/>
      <line id="${uniqueId}-hour" x1="20" y1="20" x2="20" y2="11" stroke="${pointerColor}" stroke-width="2"/>
      <line id="${uniqueId}-minute" x1="20" y1="20" x2="20" y2="7" stroke="${pointerColor}" stroke-width="1"/>
    `;
    
    container.appendChild(labelDiv);
    container.appendChild(svg);
    
    function updateClock() {
      try {
        const now = new Date();
        const timeStr = now.toLocaleTimeString("en-US", {
          hour12: false, hour: "2-digit", minute: "2-digit", timeZone
        });
        const [h, m] = timeStr.split(":").map(Number);
        const hourHand = svg.querySelector(`#${uniqueId}-hour`);
        const minuteHand = svg.querySelector(`#${uniqueId}-minute`);
        if (hourHand && minuteHand) {
          hourHand.setAttribute("transform", `rotate(${(h % 12) * 30 + m * 0.5} 20 20)`);
          minuteHand.setAttribute("transform", `rotate(${m * 6} 20 20)`);
        }
      } catch (e) {}
    }
    
    updateClock();
    setInterval(updateClock, 1000);
    
    return container;
  }
  
  const utcClock = createClock("UTC", "UTC");
  const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const localClock = createClock("Asia/Taipei", localTz);
  
  clockContainer.appendChild(utcClock);
  clockContainer.appendChild(localClock);

  const iconRow = document.createElement("div");
  iconRow.style.marginTop = "8px";

  function addIcon(name, text) {
    const d = document.createElement("div");
    d.style.cssText = "display:flex;align-items:center;margin-bottom:4px;";
    const i = document.createElement("img");
    i.src = ICON_MAP[name];
    i.style.cssText = "width:18px;height:18px;margin-right:8px;";
    const t = document.createElement("span");
    t.style.fontSize = "12px";
    t.textContent = text;
    d.appendChild(i);
    d.appendChild(t);
    iconRow.appendChild(d);
  }

  if (metar) {
    const w = metar.match(/((\d{3}|VRB))(\d{2})KT/);
    const vis = metar.match(/ (\d{4}) /);
    const cloudMatches = [...metar.matchAll(/(FEW|SCT|BKN|OVC)(\d{3})/g)];
    const temp = metar.match(/ (M?\d{2})\/(M?\d{2}) /);
    const qnh = metar.match(/Q(\d{4})/);
    const fog = /FG|BR/.test(metar);

    if (w) {
      const dir = w[1] === "VRB" ? 0 : parseInt(w[1]);
      const spd = w[3];
      const d = document.createElement("div");
      d.style.cssText = "display:flex;align-items:center;margin-bottom:4px;";
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "18");
      svg.setAttribute("height", "18");
      svg.style.cssText = "background:white;border-radius:50%;margin-right:8px;";
      svg.innerHTML = `<polygon points="9,2 7,9 9,7.5 11,9" fill="red"/>`;
      svg.style.transform = `rotate(${dir}deg)`;
      const t = document.createElement("span");
      t.style.fontSize = "12px";
      t.textContent = `${w[1]}Â° ${spd}kt`;
      d.appendChild(svg);
      d.appendChild(t);
      iconRow.appendChild(d);
    }
    if (vis) addIcon("visibility", `${(parseInt(vis[1]) / 1000).toFixed(3)} km`);
    if (cloudMatches.length) {
      cloudMatches.forEach(cloud => {
        addIcon(`cloud-${cloud[1].toLowerCase()}`, `${cloud[1]} @ ${parseInt(cloud[2]) * 100}ft`);
      });
    }
    if (temp) {
      const t1 = temp[1].replace("M", "-");
      const t2 = temp[2].replace("M", "-");
      addIcon("temperature", `${t1}Â°C / ${t2}Â°C`);
    }
    if (qnh) addIcon("pressure", `Q${qnh[1]}`);
    if (fog) addIcon("fog", "Fog/Mist");
  }

  widget.innerHTML = '';
  widget.appendChild(title);
  widget.appendChild(searchDiv);
  widget.appendChild(clockContainer);
  widget.appendChild(iconRow);
}
// åˆå§‹åŒ– METAR
fetchMETAR("RCTP").then(metar => {
  if (metar) showMetarWidget(metar, "RCTP");
  else showMetarWidget(null, "RCTP");
});

// ç§»é™¤å³ä¸‹è§’çš„ UTC Time Box
const oldUtcTime = document.getElementById('utcTime');
if (oldUtcTime) oldUtcTime.remove();
// ========== Search Box System ==========
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const clearSearchBtn = document.getElementById('clearSearch');

let searchTimeout;
let airportCache = new Map();

searchInput.addEventListener('input', function() {
  const query = this.value.trim();
  clearSearchBtn.style.display = query ? 'block' : 'none';
  
  if (!query) {
    searchResults.style.display = 'none';
    return;
  }
  
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => performSearch(query), 300);
});

clearSearchBtn.addEventListener('click', function() {
  searchInput.value = '';
  clearSearchBtn.style.display = 'none';
  searchResults.style.display = 'none';
  searchInput.focus();
});

searchInput.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    this.value = '';
    clearSearchBtn.style.display = 'none';
    searchResults.style.display = 'none';
  }
});

async function performSearch(query) {
  const upperQuery = query.toUpperCase();
  const results = [];
  
  // æœå°‹èˆªç­ (callsign)
  for (const [id, aircraft] of aircrafts.entries()) {
    const data = aircraft.data;
    if (data.callsign && data.callsign.toUpperCase().includes(upperQuery)) {
      results.push({
        type: 'flight',
        id: id,
        data: data,
        score: data.callsign.toUpperCase().startsWith(upperQuery) ? 2 : 1
      });
    }
  }
  
  // æœå°‹æ©Ÿå ´
  const airports = await searchAirports(upperQuery);
  airports.forEach(apt => {
    results.push({
      type: 'airport',
      data: apt,
      score: apt.ident === upperQuery ? 3 : (apt.ident.startsWith(upperQuery) ? 2 : 1)
    });
  });
  
  // æ’åº
  results.sort((a, b) => b.score - a.score);
  
  displaySearchResults(results.slice(0, 10));
}

async function searchAirports(query) {
  // å…ˆæª¢æŸ¥ cache
  if (airportCache.has(query)) {
    return airportCache.get(query);
  }
  
  try {
    const upperQuery = query.toUpperCase();
    
    // ä½¿ç”¨ GitHub çš„æ©Ÿå ´è³‡æ–™åº«
    const response = await fetch('https://raw.githubusercontent.com/mwgg/Airports/refs/heads/master/airports.json');
    
    if (!response.ok) throw new Error('Failed to fetch airports database');
    
    const airports = await response.json();
    
    // æœå°‹åŒ¹é…çš„æ©Ÿå ´
    const results = [];
    
    for (const icao in airports) {
      const apt = airports[icao];
      const icaoCode = icao.toUpperCase();
      const name = (apt.name || '').toUpperCase();
      const iata = (apt.iata || '').toUpperCase();
      
      // æª¢æŸ¥æ˜¯å¦åŒ¹é…
      if (icaoCode.includes(upperQuery) || 
          name.includes(upperQuery) || 
          iata.includes(upperQuery)) {
        
        results.push({
          ident: icao,
          name: apt.name,
          latitude_deg: apt.lat,
          longitude_deg: apt.lon,
          municipality: apt.city,
          iso_country: apt.country,
          iata: apt.iata
        });
        
        // é™åˆ¶çµæœæ•¸é‡
        if (results.length >= 10) break;
      }
    }
    
    // æ’åº:å®Œå…¨åŒ¹é…å„ªå…ˆ
    results.sort((a, b) => {
      const aExact = a.ident === upperQuery || a.iata === upperQuery;
      const bExact = b.ident === upperQuery || b.iata === upperQuery;
      if (aExact && !bExact) return -1;
      if (!aExact && bExact) return 1;
      
      const aStarts = a.ident.startsWith(upperQuery) || (a.iata && a.iata.startsWith(upperQuery));
      const bStarts = b.ident.startsWith(upperQuery) || (b.iata && b.iata.startsWith(upperQuery));
      if (aStarts && !bStarts) return -1;
      if (!aStarts && bStarts) return 1;
      
      return 0;
    });
    
    airportCache.set(query, results);
    return results;
    
  } catch (error) {
    console.error('Airport search failed:', error);
    return [];
  }
}

function displaySearchResults(results) {
  if (results.length === 0) {
    searchResults.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #999;">
        No results found
      </div>
    `;
    searchResults.style.display = 'block';
    return;
  }
  
  searchResults.innerHTML = results.map(result => {
    if (result.type === 'flight') {
      const data = result.data;
      const color = getAltitudeColor(data.alt);
      return `
        <div class="search-result-item" onclick="selectFlight('${result.id}')" 
             style="padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 24px;">âœˆï¸</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 15px; color: #000;">
                ${escapeHtml(data.callsign || 'UNKNOWN')}
              </div>
              <div style="font-size: 13px; color: #666; margin-top: 2px;">
                ${escapeHtml(data.type || '??')} â€¢ 
                <span style="color: ${color}; font-weight: 600;">${Math.round(data.alt || 0)}ft</span> â€¢ 
                ${formatSpeed(data.speed)}kt
              </div>
              ${data.departure && data.arrival ? `
                <div style="font-size: 12px; color: #999; margin-top: 2px;">
                  ${escapeHtml(data.departure.substring(0, 4))} â†’ ${escapeHtml(data.arrival.substring(0, 4))}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    } else {
      const apt = result.data;
      return `
        <div class="search-result-item" onclick="selectAirport(${apt.latitude_deg}, ${apt.longitude_deg}, '${escapeHtml(apt.ident)}', '${escapeHtml(apt.name).replace(/'/g, "\\'")}')"
             style="padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 24px;">ğŸ›«</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 15px; color: #000;">
                ${escapeHtml(apt.ident)}
              </div>
              <div style="font-size: 13px; color: #666; margin-top: 2px;">
                ${escapeHtml(apt.name)}
              </div>
              <div style="font-size: 12px; color: #999; margin-top: 2px;">
                ${apt.municipality ? escapeHtml(apt.municipality) + ', ' : ''}${escapeHtml(apt.iso_country || '')}
              </div>
            </div>
          </div>
        </div>
      `;
    }
  }).join('');
  
  searchResults.style.display = 'block';
  
  // æ·»åŠ  hover æ•ˆæœ
  document.querySelectorAll('.search-result-item').forEach(item => {
    item.addEventListener('mouseenter', function() {
      this.style.background = '#f5f5f5';
    });
    item.addEventListener('mouseleave', function() {
      this.style.background = 'white';
    });
  });
}

function selectFlight(aircraftId) {
  if (!aircrafts.has(aircraftId)) return;
  
  const aircraft = aircrafts.get(aircraftId);
  const data = aircraft.data;
  
  // é—œé–‰æœå°‹çµæœ
  searchResults.style.display = 'none';
  searchInput.value = '';
  clearSearchBtn.style.display = 'none';
  
  // èšç„¦é£›æ©Ÿ
  clearAllAircraftTracks();
  focusedAircraftId = aircraftId;
  showAircraftTrack(aircraftId);
  showAircraftPanel(data, aircraftId);
  
  // å¹³æ»‘ç§»å‹•åœ°åœ–
  map.flyTo([data.lat, data.lon], 10, {
    duration: 1.5,
    easeLinearity: 0.5
  });
}

async function selectAirport(lat, lon, icao, name) {
  // é—œé–‰æœå°‹çµæœ
  searchResults.style.display = 'none';
  searchInput.value = '';
  clearSearchBtn.style.display = 'none';
  
  // å¹³æ»‘ç§»å‹•åˆ°æ©Ÿå ´
  map.flyTo([lat, lon], 12, {
    duration: 1.5,
    easeLinearity: 0.5
  });
  
  // é¡¯ç¤ºæ©Ÿå ´ Marker ä¸¦åŠ ä¸Š permanent tooltip
  const airportMarker = L.marker([lat, lon], {
    icon: L.divIcon({
      html: '<div style="font-size: 32px;">ğŸ›«</div>',
      className: 'airport-marker',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    }),
    zIndexOffset: 1000
  }).addTo(map);
  
  // æ·»åŠ  permanent tooltip é¡¯ç¤ºæ©Ÿå ´ä½ç½®å’Œ ICAO
  airportMarker.bindTooltip(`
    <div style="text-align: center;">
      <div style="font-weight: 700; font-size: 14px; color: #000;">${escapeHtml(icao)}</div>
      <div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(name)}</div>
    </div>
  `, {
    permanent: true,
    direction: 'top',
    offset: [0, -20],
    className: 'airport-tooltip'
  }).openTooltip();
  
  // 10 ç§’å¾Œè‡ªå‹•ç§»é™¤ marker å’Œ tooltip
  setTimeout(() => {
    map.removeLayer(airportMarker);
  }, 10000);
  
  // è‡ªå‹•æ‰“é–‹ METAR Widget ä¸¦æŸ¥è©¢è©²æ©Ÿå ´å¤©æ°£
  const metar = await fetchMETAR(icao);
  if (metar) {
    showMetarWidget(metar, icao);
    
    // ç¢ºä¿ METAR widget æ˜¯æ‰“é–‹çš„
    const widget = document.getElementById('metarWidget');
    if (widget) {
      widget.classList.add('open');
    }
  } else {
    // å³ä½¿æ²’æœ‰ METAR æ•¸æ“šï¼Œä¹Ÿæ‰“é–‹ widget é¡¯ç¤ºæœå°‹æ¡†
    showMetarWidget(null, icao);
    const widget = document.getElementById('metarWidget');
    if (widget) {
      widget.classList.add('open');
    }
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    alert(`No METAR data available for ${icao}`);
  }
  
  // é¡¯ç¤ºæ©Ÿå ´è³‡è¨Š popup (5ç§’å¾Œæ¶ˆå¤±)
  const popup = L.popup()
    .setLatLng([lat, lon])
    .setContent(`
      <div style="padding: 12px;">
        <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px; color: #0066cc;">
          ${escapeHtml(icao)}
        </div>
        <div style="font-size: 13px; color: #333; margin-bottom: 4px;">
          ${escapeHtml(name)}
        </div>
        <div style="font-size: 11px; color: #999; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
          ğŸ“ ${lat.toFixed(4)}Â°, ${lon.toFixed(4)}Â°
        </div>
      </div>
    `)
    .openOn(map);
  
  setTimeout(() => {
    map.closePopup(popup);
  }, 5000);
}
loadAirlines();
</script>
</body>
</html>.