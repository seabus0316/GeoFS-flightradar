<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>GeoFS ATC Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .label {
      font-family: Inter, "Noto Sans TC", Arial, sans-serif;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5);
      white-space: nowrap;
      margin-left: 6px;
    }

    .legend {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(146, 146, 146, 0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .altitude-legend {
      position: absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(146, 146, 146, 0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:11px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      min-width: 140px;
    }
    .altitude-legend-item {
      display: flex;
      align-items: center;
      margin: 2px 0;
    }
    .altitude-color-box {
      width: 12px;
      height: 12px;
      margin-right: 6px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">GeoFS ATC â€” connected: <span id="connCount">0</span></div>
<div class="altitude-legend">
  <div style="font-weight:bold;margin-bottom:4px;">é«˜åº¦åœ–ä¾‹</div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffffff;"></div><span><100m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ffff00;"></div><span>100m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00ff00;"></div><span>~1000m</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#00bfff;"></div><span>2500m+</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#0000ff;"></div><span>é«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#800080;"></div><span>æ¥µé«˜ç©º</span></div>
  <div class="altitude-legend-item"><div class="altitude-color-box" style="background:#ff0000;"></div><span>æœ€é«˜ç©º</span></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';

// FR24 é¡è‰²é‚è¼¯
function getAltitudeColor(altFt) {
  const alt = altFt || 0;
  if (alt < 330) return "#ffffff";
  if (alt < 3300) return "#ffff00";
  if (alt < 8200) return "#00ff00";
  if (alt < 20000) return "#00bfff";
  if (alt < 30000) return "#0000ff";
  if (alt < 40000) return "#800080";
  return "#ff0000";
}

// ä¿®æ­£é€Ÿåº¦å–®ä½
function formatSpeed(speedRaw) {
  if (typeof speedRaw !== 'number') return '---';
  let speed = speedRaw;
  // å‡è¨­é€Ÿåº¦å°æ–¼ 50 â†’ m/s â†’ è½‰ kt
  if (speedRaw < 50) speed = speedRaw * 1.94384;
  return Math.round(speed);
}

// è¨ˆç®—å…©é»é–“çš„è·é›¢ï¼ˆå…¬é‡Œï¼‰
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// é©—è­‰è»Œè·¡é»æ˜¯å¦åˆç†
function isValidTrackPoint(prevPoint, newPoint, maxDistanceKm = 500, maxTimeGapMs = 300000) {
  if (!prevPoint || !newPoint) return true;
  
  // æª¢æŸ¥è·é›¢
  const distance = calculateDistance(prevPoint.lat, prevPoint.lon, newPoint.lat, newPoint.lon);
  if (distance > maxDistanceKm) {
    console.warn(`Track point rejected: distance ${distance.toFixed(1)}km exceeds limit`);
    return false;
  }
  
  // æª¢æŸ¥æ™‚é–“é–“éš”ï¼ˆå¦‚æœæœ‰æ™‚é–“æˆ³ï¼‰
  if (prevPoint.timestamp && newPoint.timestamp) {
    const timeDiff = Math.abs(newPoint.timestamp - prevPoint.timestamp);
    if (timeDiff > maxTimeGapMs) {
      console.warn(`Track point rejected: time gap ${timeDiff}ms exceeds limit`);
      return false;
    }
  }
  
  return true;
}

// Tile Layers
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');

const map = L.map('map', {
  worldCopyJump: false, maxZoom: 18, minZoom: 2,
  maxBounds: [[-85,-180],[85,180]], layers: [googleSat]
}).setView([20,0],2);

L.control.layers({"OpenStreetMap": osmLayer,"Google Streets":googleStreet,"Google Satellite":googleSat}).addTo(map);

const aircrafts = new Map();
const PLANE_IMG = "https://i.ibb.co/6cNhyMMj/1.png";
const MAX_TRACK_POINTS = 5000;

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

// ICON
function makeDivIcon(data){
  const imgW=32,imgH=32,labelW=150,labelH=50,iconW=imgW+labelW,iconH=Math.max(imgH,labelH);
  const color=getAltitudeColor(data.alt);
  return L.divIcon({
    html:`
      <div style="display:flex;align-items:center;width:${iconW}px;height:${iconH}px;">
        <img src="${PLANE_IMG}" width="${imgW}" height="${imgH}" style="transform:rotate(${data.heading||0}deg);"/>
        <div class="label" style="border-left:3px solid ${color};">
          <strong>${escapeHtml(data.callsign||'UNK')}</strong>
          <div style="font-size:11px;">
            ${escapeHtml(data.type||'??')} Â· <span style="color:${color};font-weight:bold;">${Math.round(data.alt||0)}ft</span> Â· ${formatSpeed(data.speed)}kt
          </div>
          <div style="font-size:11px;">${escapeHtml(data.flightNo||'')} ${escapeHtml(data.departure||'')}â†’${escapeHtml(data.arrival||'')}</div>
        </div>
      </div>`,
    className:'',iconSize:[iconW,iconH],iconAnchor:[imgW/2,iconH/2]
  });
}

// ğŸ”¥ ä¿®æ­£ï¼šå¾æ­·å²è»Œè·¡å‰µå»ºè»Œè·¡ç·šæ®µï¼ŒåŠ å…¥é©—è­‰é‚è¼¯
function createHistoricalTrack(aircraftId, tracks) {
  if (!aircrafts.has(aircraftId)) {
    // å¦‚æœé£›æ©Ÿä¸å­˜åœ¨ï¼Œå…ˆå‰µå»ºåŸºæœ¬çµæ§‹
    const lastTrack = tracks[tracks.length - 1];
    if (lastTrack) {
      const dummyData = {
        callsign: aircraftId,
        type: '??',
        lat: lastTrack.lat,
        lon: lastTrack.lon,
        alt: lastTrack.alt,
        heading: 0,
        speed: 0
      };
      const marker = L.marker([lastTrack.lat, lastTrack.lon], {icon: makeDivIcon(dummyData)}).addTo(map);
      marker.on('click', () => showAircraftPanel(dummyData));
      aircrafts.set(aircraftId, {
        marker,
        segments: [],
        path: [],
        lastSeen: Date.now(),
        data: dummyData
      });
    }
  }
  
  const obj = aircrafts.get(aircraftId);
  if (!obj) return;
  
  // æ¸…é™¤ç¾æœ‰è»Œè·¡
  obj.segments.forEach(s => map.removeLayer(s));
  obj.segments = [];
  obj.path = [];
  
  // ğŸ”¥ ä¿®æ­£ï¼šé‡å»ºæ­·å²è»Œè·¡ï¼ŒåŠ å…¥é©—è­‰
  if (tracks.length > 1) {
    let validTracks = [tracks[0]]; // ç¬¬ä¸€å€‹é»ç¸½æ˜¯æœ‰æ•ˆçš„
    
    // éæ¿¾æ‰ç•°å¸¸çš„è»Œè·¡é»
    for (let i = 1; i < tracks.length; i++) {
      const prev = validTracks[validTracks.length - 1];
      const curr = tracks[i];
      
      if (isValidTrackPoint(prev, curr)) {
        validTracks.push(curr);
      } else {
        console.log(`Skipped invalid track point for ${aircraftId}:`, curr);
      }
    }
    
    // å‰µå»ºç·šæ®µï¼Œä½†åªåœ¨é€£çºŒçš„æœ‰æ•ˆé»ä¹‹é–“é€£ç·š
    for (let i = 1; i < validTracks.length; i++) {
      const prev = validTracks[i-1];
      const curr = validTracks[i];
      const prevLatLng = [prev.lat, prev.lon];
      const currLatLng = [curr.lat, curr.lon];
      
      // å†æ¬¡æª¢æŸ¥è·é›¢ï¼Œé¿å…éé•·çš„é€£ç·š
      const distance = calculateDistance(prev.lat, prev.lon, curr.lat, curr.lon);
      if (distance > 100) { // 100å…¬é‡Œä»¥ä¸Šè¦–ç‚ºä¸é€£çºŒ
        console.log(`Breaking track segment due to large distance: ${distance.toFixed(1)}km`);
        continue;
      }
      
      const color = getAltitudeColor(curr.alt);
      const seg = L.polyline([prevLatLng, currLatLng], {
        color: color,
        weight: 2,
        opacity: 0.8
      }).addTo(map);
      
      seg.bindTooltip(`${Math.round(curr.alt || 0)} ft`, {permanent: false});
      obj.segments.push(seg);
      
      // é™åˆ¶è»Œè·¡æ®µæ•¸é‡
      if (obj.segments.length > MAX_TRACK_POINTS) {
        map.removeLayer(obj.segments.shift());
      }
    }
    
    // æ›´æ–°è·¯å¾‘æ•¸çµ„
    obj.path = validTracks.map(t => [t.lat, t.lon]);
    
    console.log(`Restored ${validTracks.length}/${tracks.length} valid track points for ${aircraftId}`);
  }
}

// ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤é£›æ©Ÿè»Œè·¡
function clearAircraftTrack(aircraftId) {
  if (aircrafts.has(aircraftId)) {
    const obj = aircrafts.get(aircraftId);
    obj.segments.forEach(s => map.removeLayer(s));
    obj.segments = [];
    obj.path = [];
    console.log(`Cleared track for ${aircraftId}`);
  }
}

// ğŸ”¥ ä¿®æ­£ï¼šæ›´æ–°é£›æ©Ÿï¼ŒåŠ å¼·è»Œè·¡é€£ç·šçš„é©—è­‰
function updateAircraft(id, data, trackPoint = null) {
  const latlng = [data.lat, data.lon];
  const color = getAltitudeColor(data.alt);
  
  if (aircrafts.has(id)) {
    const obj = aircrafts.get(id);
    obj.marker.setLatLng(latlng);
    obj.marker.setIcon(makeDivIcon(data));
    obj.lastSeen = Date.now();
    obj.data = data;
    
    // ğŸ”¥ åªæœ‰ç•¶æœ‰æ–°è»Œè·¡é»ä¸”é©—è­‰é€šéæ™‚æ‰æ·»åŠ ç·šæ®µ
    if (trackPoint && obj.path.length > 0) {
      const prev = obj.path[obj.path.length - 1];
      const distance = calculateDistance(prev[0], prev[1], latlng[0], latlng[1]);
      
      // è¨­å®šæ›´åš´æ ¼çš„è·é›¢é™åˆ¶
      const maxDistance = 50; // 50å…¬é‡Œ
      
      if (distance < maxDistance) {
        const seg = L.polyline([prev, latlng], {color, weight: 2, opacity: 0.8}).addTo(map);
        seg.bindTooltip(`${Math.round(data.alt || 0)} ft`, {permanent: false});
        obj.segments.push(seg);
        if (obj.segments.length > MAX_TRACK_POINTS) {
          map.removeLayer(obj.segments.shift());
        }
      } else {
        // è¶…éè·é›¢ â†’ è¦–ç‚ºç¬ç§»ï¼Œæ¸…é™¤è»Œè·¡é¿å…ç›´ç·š
        console.log(`Distance too large (${distance.toFixed(1)}km), clearing track for ${id}`);
        clearAircraftTrack(id);
      }
    }
    
    // æ·»åŠ åˆ°è·¯å¾‘ï¼ˆç„¡è«–æ˜¯å¦ç•«ç·šï¼‰
    if (trackPoint) {
      obj.path.push(latlng);
      if (obj.path.length > MAX_TRACK_POINTS) obj.path.shift();
    }

  } else {
    const marker = L.marker(latlng, {icon: makeDivIcon(data)}).addTo(map);
    marker.on('click', () => showAircraftPanel(data));
    aircrafts.set(id, {
      marker,
      segments: [],
      path: trackPoint ? [latlng] : [],
      lastSeen: Date.now(),
      data
    });
  }
  document.getElementById('connCount').textContent = aircrafts.size;
}

function removeAircraft(id) {
  if (aircrafts.has(id)) {
    const o = aircrafts.get(id);
    map.removeLayer(o.marker);
    o.segments.forEach(s => map.removeLayer(s));
    aircrafts.delete(id);
    document.getElementById('connCount').textContent = aircrafts.size;
  }
}

function removeStaleAircrafts(ms = 30000) {
  const now = Date.now();
  for (const [k, v] of aircrafts.entries()) {
    if (now - v.lastSeen > ms) {
      map.removeLayer(v.marker);
      v.segments.forEach(s => map.removeLayer(s));
      aircrafts.delete(k);
    }
  }
  document.getElementById('connCount').textContent = aircrafts.size;
}
setInterval(() => removeStaleAircrafts(), 5000);

// Panel
function showAircraftPanel(data) {
  let p = document.getElementById('aircraftPanel');
  if (!p) {
    p = document.createElement('div');
    p.id = 'aircraftPanel';
    Object.assign(p.style, {
      position: 'absolute', top: '50px', right: '10px', width: '250px',
      background: 'rgba(0,0,0,0.85)',
      color: '#fff',
      borderRadius: '8px', padding: '10px',
      boxShadow: '0 2px 6px rgba(0,0,0,0.7)',
      fontSize: '13px', zIndex: 9999
    });
    document.body.appendChild(p);
  }
  const c = getAltitudeColor(data.alt);
  p.innerHTML = `
    <h3 style="margin:0 0 5px;border-left:3px solid ${c};padding-left:8px;">${escapeHtml(data.callsign || 'UNK')}</h3>
    <div><strong>Flight:</strong> ${escapeHtml(data.flightNo || '')}</div>
    <div><strong>Route:</strong> ${escapeHtml(data.departure || '')} â†’ ${escapeHtml(data.arrival || '')}</div>
    <div><strong>Aircraft:</strong> ${escapeHtml(data.type || '')}</div>
    <div><strong>Altitude:</strong> <span style="color:${c};font-weight:bold;">${Math.round(data.alt || 0)} ft</span></div>
    <div><strong>Speed:</strong> ${formatSpeed(data.speed)} kt</div>
    <div><strong>Takeoff (UTC):</strong> ${escapeHtml(data.takeoffTime || 'â€”')}</div>
    <button onclick="document.getElementById('aircraftPanel').remove()" style="margin-top:8px;padding:4px 8px;">Close</button>`;
}

// WebSocket
let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', () => ws.send(JSON.stringify({type: 'hello', role: 'atc'})));
  ws.addEventListener('message', ev => {
    try {
      const m = JSON.parse(ev.data);
      if (m.type === 'aircraft_update') {
        (Array.isArray(m.payload) ? m.payload : [m.payload]).forEach(a => 
          updateAircraft(a.id, a, m.trackPoint)
        );
      }
      else if (m.type === 'aircraft_snapshot') {
        m.payload.forEach(a => updateAircraft(a.id, a));
      }
      // ğŸ”¥ æ–°å¢ï¼šè™•ç†æ­·å²è»Œè·¡
      else if (m.type === 'aircraft_track_history') {
        const { aircraftId, tracks } = m.payload;
        createHistoricalTrack(aircraftId, tracks);
      }
      // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤è»Œè·¡
      else if (m.type === 'aircraft_track_clear') {
        const { aircraftId } = m.payload;
        clearAircraftTrack(aircraftId);
      }
      else if (m.type === 'aircraft_remove') {
        m.payload.forEach(id => removeAircraft(id));
      }
    } catch (e) {
      console.warn('Message parse error:', e);
    }
  });
  ws.addEventListener('close', () => setTimeout(connectWS, 2000));
  ws.addEventListener('error', () => ws.close());
}
connectWS();
</script>
</body>
</html>
