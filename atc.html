// åœ¨ WebSocket é€£æ¥éƒ¨åˆ†æ·»åŠ è«‹æ±‚æ­·å²æ•¸æ“šçš„åŠŸèƒ½
function connectWS() {
  ws = new WebSocket(WS_URL);
  
  ws.addEventListener('open', () => {
    ws.send(JSON.stringify({type: 'hello', role: 'atc'}));
    
    // ğŸ”¥ æ–°å¢ï¼šä¸»å‹•è«‹æ±‚æ‰€æœ‰åœ¨ç·šé£›æ©Ÿçš„æ­·å²è»Œè·¡
    setTimeout(() => {
      ws.send(JSON.stringify({
        type: 'request_all_history',
        payload: {
          maxPoints: 10000, // è«‹æ±‚æ›´å¤šæ­·å²é»
          timeRange: 3600000 // è«‹æ±‚éå»1å°æ™‚çš„æ•¸æ“š
        }
      }));
    }, 1000);
  });
  
  ws.addEventListener('message', ev => {
    try {
      const m = JSON.parse(ev.data);
      
      if (m.type === 'aircraft_update') {
        (Array.isArray(m.payload) ? m.payload : [m.payload]).forEach(a => 
          updateAircraft(a.id, a, m.trackPoint)
        );
      }
      else if (m.type === 'aircraft_snapshot') {
        m.payload.forEach(a => {
          updateAircraft(a.id, a);
          // ğŸ”¥ å°æ¯æ¶é£›æ©Ÿè«‹æ±‚æ­·å²è»Œè·¡
          ws.send(JSON.stringify({
            type: 'request_aircraft_history',
            payload: {
              aircraftId: a.id,
              maxPoints: 5000,
              timeRange: 7200000 // 2å°æ™‚
            }
          }));
        });
      }
      // è™•ç†æ­·å²è»Œè·¡ï¼ˆæ”¾å¯¬é©—è­‰æ¢ä»¶ï¼‰
      else if (m.type === 'aircraft_track_history') {
        const { aircraftId, tracks } = m.payload;
        createHistoricalTrackImproved(aircraftId, tracks);
      }
      else if (m.type === 'aircraft_track_clear') {
        const { aircraftId } = m.payload;
        clearAircraftTrack(aircraftId);
      }
      else if (m.type === 'aircraft_remove') {
        m.payload.forEach(id => removeAircraft(id));
      }
    } catch (e) {
      console.warn('Message parse error:', e);
    }
  });
  
  ws.addEventListener('close', () => setTimeout(connectWS, 2000));
  ws.addEventListener('error', () => ws.close());
}

// ğŸ”¥ æ”¹é€²çš„æ­·å²è»Œè·¡å‰µå»ºå‡½æ•¸ - æ”¾å¯¬é©—è­‰æ¢ä»¶
function createHistoricalTrackImproved(aircraftId, tracks) {
  if (!aircrafts.has(aircraftId)) {
    const lastTrack = tracks[tracks.length - 1];
    if (lastTrack) {
      const dummyData = {
        callsign: aircraftId,
        type: lastTrack.type || '??',
        lat: lastTrack.lat,
        lon: lastTrack.lon,
        alt: lastTrack.alt,
        heading: lastTrack.heading || 0,
        speed: lastTrack.speed || 0,
        flightNo: lastTrack.flightNo || '',
        departure: lastTrack.departure || '',
        arrival: lastTrack.arrival || ''
      };
      const marker = L.marker([lastTrack.lat, lastTrack.lon], {icon: makeDivIcon(dummyData)}).addTo(map);
      marker.on('click', () => showAircraftPanel(dummyData));
      aircrafts.set(aircraftId, {
        marker,
        segments: [],
        path: [],
        lastSeen: Date.now(),
        data: dummyData
      });
    }
  }
  
  const obj = aircrafts.get(aircraftId);
  if (!obj) return;
  
  // æ¸…é™¤ç¾æœ‰è»Œè·¡
  obj.segments.forEach(s => map.removeLayer(s));
  obj.segments = [];
  obj.path = [];
  
  if (tracks.length > 1) {
    console.log(`Processing ${tracks.length} historical track points for ${aircraftId}`);
    
    // ğŸ”¥ æ”¹é€²ï¼šæ›´æ™ºèƒ½çš„è»Œè·¡åˆ†æ®µè™•ç†
    let currentSegment = [tracks[0]];
    let allSegments = [];
    
    for (let i = 1; i < tracks.length; i++) {
      const prev = tracks[i-1];
      const curr = tracks[i];
      const distance = calculateDistance(prev.lat, prev.lon, curr.lat, curr.lon);
      const timeDiff = curr.timestamp && prev.timestamp ? 
        Math.abs(curr.timestamp - prev.timestamp) : 0;
      
      // ğŸ”¥ æ”¾å¯¬æ¢ä»¶ï¼šå…è¨±æ›´å¤§çš„è·é›¢å’Œæ™‚é–“é–“éš”
      const isNewSegment = distance > 200 || timeDiff > 600000; // 200km æˆ– 10åˆ†é˜
      
      if (isNewSegment && currentSegment.length > 1) {
        // çµæŸç•¶å‰æ®µï¼Œé–‹å§‹æ–°æ®µ
        allSegments.push([...currentSegment]);
        currentSegment = [curr];
      } else {
        currentSegment.push(curr);
      }
    }
    
    // æ·»åŠ æœ€å¾Œä¸€æ®µ
    if (currentSegment.length > 1) {
      allSegments.push(currentSegment);
    }
    
    // ç¹ªè£½æ‰€æœ‰è»Œè·¡æ®µ
    let totalPoints = 0;
    allSegments.forEach((segment, segIndex) => {
      // ğŸ”¥ ç‰¹æ®Šè™•ç†ï¼šèµ·é£›éšæ®µä½¿ç”¨ç‰¹æ®Šé¡è‰²
      const isInitialSegment = segIndex === 0;
      
      for (let i = 1; i < segment.length; i++) {
        const prev = segment[i-1];
        const curr = segment[i];
        const prevLatLng = [prev.lat, prev.lon];
        const currLatLng = [curr.lat, curr.lon];
        
        let color = getAltitudeColor(curr.alt);
        
        // ğŸ”¥ èµ·é£›æ®µç‰¹æ®Šæ¨™è¨˜
        if (isInitialSegment && (curr.alt || 0) < 1000) {
          color = '#ff6b35'; // æ©™ç´…è‰²æ¨™ç¤ºèµ·é£›éšæ®µ
        }
        
        const seg = L.polyline([prevLatLng, currLatLng], {
          color: color,
          weight: isInitialSegment ? 3 : 2, // èµ·é£›æ®µåŠ ç²—
          opacity: 0.9,
          dashArray: isInitialSegment ? '5,5' : null // èµ·é£›æ®µè™›ç·š
        }).addTo(map);
        
        const tooltipText = isInitialSegment ? 
          `èµ·é£›éšæ®µ: ${Math.round(curr.alt || 0)} ft` : 
          `${Math.round(curr.alt || 0)} ft`;
        
        seg.bindTooltip(tooltipText, {permanent: false});
        obj.segments.push(seg);
        totalPoints++;
        
        if (obj.segments.length > MAX_TRACK_POINTS) {
          map.removeLayer(obj.segments.shift());
        }
      }
    });
    
    // æ›´æ–°è·¯å¾‘æ•¸çµ„
    obj.path = tracks.map(t => [t.lat, t.lon]);
    
    console.log(`âœ… Restored ${totalPoints} track segments in ${allSegments.length} parts for ${aircraftId}`);
    
    // ğŸ”¥ å¦‚æœæœ‰èµ·é£›æ•¸æ“šï¼Œåœ¨åœ°åœ–ä¸Šæ¨™è¨˜èµ·é£›é»
    if (tracks.length > 0 && (tracks[0].alt || 0) < 500) {
      const takeoffPoint = tracks[0];
      const takeoffMarker = L.circleMarker([takeoffPoint.lat, takeoffPoint.lon], {
        radius: 8,
        fillColor: '#ff6b35',
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map);
      
      takeoffMarker.bindTooltip(`ğŸ›« èµ·é£›é»: ${aircraftId}`, {permanent: false});
      
      // å°‡èµ·é£›æ¨™è¨˜ä¹ŸåŠ å…¥ç®¡ç†ï¼ˆå¯é¸ï¼‰
      if (!obj.takeoffMarker) {
        obj.takeoffMarker = takeoffMarker;
      }
    }
  }
}

// ğŸ”¥ æ–°å¢ï¼šæ‰‹å‹•è«‹æ±‚ç‰¹å®šé£›æ©Ÿçš„æ­·å²æ•¸æ“š
function requestAircraftHistory(aircraftId) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'request_aircraft_history',
      payload: {
        aircraftId: aircraftId,
        maxPoints: 10000,
        timeRange: 7200000, // 2å°æ™‚
        includeGroundTrack: true // è«‹æ±‚åŒ…å«åœ°é¢æ»‘è¡Œæ•¸æ“š
      }
    }));
    console.log(`Requested full history for ${aircraftId}`);
  }
}

// ğŸ”¥ åœ¨é£›æ©Ÿé¢æ¿ä¸­æ·»åŠ è«‹æ±‚æ­·å²æŒ‰éˆ•
function showAircraftPanel(data) {
  let p = document.getElementById('aircraftPanel');
  if (!p) {
    p = document.createElement('div');
    p.id = 'aircraftPanel';
    Object.assign(p.style, {
      position: 'absolute', top: '50px', right: '10px', width: '280px',
      background: 'rgba(0,0,0,0.85)',
      color: '#fff',
      borderRadius: '8px', padding: '10px',
      boxShadow: '0 2px 6px rgba(0,0,0,0.7)',
      fontSize: '13px', zIndex: 9999
    });
    document.body.appendChild(p);
  }
  
  const c = getAltitudeColor(data.alt);
  p.innerHTML = `
    <h3 style="margin:0 0 5px;border-left:3px solid ${c};padding-left:8px;">${escapeHtml(data.callsign || 'UNK')}</h3>
    <div><strong>Flight:</strong> ${escapeHtml(data.flightNo || '')}</div>
    <div><strong>Route:</strong> ${escapeHtml(data.departure || '')} â†’ ${escapeHtml(data.arrival || '')}</div>
    <div><strong>Aircraft:</strong> ${escapeHtml(data.type || '')}</div>
    <div><strong>Altitude:</strong> <span style="color:${c};font-weight:bold;">${Math.round(data.alt || 0)} ft</span></div>
    <div><strong>Speed:</strong> ${formatSpeed(data.speed)} kt</div>
    <div><strong>Takeoff (UTC):</strong> ${escapeHtml(data.takeoffTime || 'â€”')}</div>
    <div style="margin-top:8px;">
      <button onclick="requestAircraftHistory('${data.callsign || data.id}')" 
              style="padding:4px 8px;margin-right:5px;background:#007acc;color:white;border:none;border-radius:4px;cursor:pointer;">
        è«‹æ±‚å®Œæ•´è»Œè·¡
      </button>
      <button onclick="document.getElementById('aircraftPanel').remove()" 
              style="padding:4px 8px;background:#666;color:white;border:none;border-radius:4px;cursor:pointer;">
        é—œé–‰
      </button>
    </div>`;
}
